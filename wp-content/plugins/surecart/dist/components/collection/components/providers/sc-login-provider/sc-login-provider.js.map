{"version":3,"file":"sc-login-provider.js","sourceRoot":"","sources":["../../../../src/components/providers/sc-login-provider/sc-login-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Prop, h, Watch, State, Host, Listen, Event, EventEmitter } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '../../../functions/fetch';\nimport { Checkout } from '../../../types';\n\n@Component({\n  tag: 'sc-login-provider',\n  styleUrl: 'sc-login-provider.css',\n  shadow: true,\n})\nexport class ScLoginProvider {\n  private loginForm: HTMLScFormElement;\n\n  /** Is the user logged in. */\n  @Prop() loggedIn: boolean;\n  @Prop() order: Checkout;\n\n  @Event() scSetLoggedIn: EventEmitter<boolean>;\n  @Event() scSetCustomer: EventEmitter<{ email: string; name?: string }>;\n\n  @State() notice: boolean;\n  @State() open: boolean;\n  @State() loading: boolean;\n  @State() error: string;\n\n  /** Listen for open event. */\n  @Listen('scLoginPrompt')\n  handleLoginPrompt() {\n    this.open = true;\n  }\n\n  /** Focus on first input. */\n  @Watch('open')\n  handleLoginDialogChange(val) {\n    if (val) {\n      setTimeout(() => {\n        this.loginForm.querySelector('sc-input').triggerFocus();\n      }, 100);\n    }\n  }\n\n  @Watch('loggedIn')\n  handleLoggedInChange(val, prev) {\n    if (prev === false && val) {\n      this.notice = true;\n    }\n  }\n\n  @Watch('order')\n  handleOrderChange(val, prev) {\n    if (val?.updated_at !== prev?.updated_at) {\n      this.notice = false;\n    }\n  }\n\n  /** Handle form submit. */\n  async handleFormSubmit(e) {\n    e.preventDefault();\n    e.stopImmediatePropagation();\n    this.error = null;\n\n    const { login, password } = await e.target.getFormJson();\n\n    try {\n      this.loading = true;\n      const { name, email } = (await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/login',\n        data: {\n          login,\n          password,\n        },\n      })) as { name: string; email: string };\n      this.scSetLoggedIn.emit(true);\n      this.scSetCustomer.emit({ name, email });\n      this.open = false;\n    } catch (e) {\n      console.error(e);\n      this.error = e?.message || __('Something went wrong', 'surecart');\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  render() {\n    return (\n      <Host>\n        {!!this.notice && (\n          <sc-alert type=\"success\" open style={{ marginBottom: 'var(--sc-form-row-spacing)' }} closable>\n            <span slot=\"title\">{__('Welcome back!', 'surecart')}</span>\n            {__('You have logged in successfully.', 'surecart')}\n          </sc-alert>\n        )}\n\n        <slot />\n\n        {!this.loggedIn && (\n          <sc-dialog label={__('Login to your account', 'surecart')} open={this.open} onScRequestClose={() => (this.open = false)}>\n            <sc-form\n              ref={el => (this.loginForm = el as HTMLScFormElement)}\n              onScFormSubmit={e => {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n              }}\n              onScSubmit={e => this.handleFormSubmit(e)}\n            >\n              {!!this.error && (\n                <sc-alert type=\"danger\" open={!!this.error}>\n                  {this.error}\n                </sc-alert>\n              )}\n              <sc-input label={__('Email or Username', 'surecart')} type=\"text\" name=\"login\" required autofocus={this.open}></sc-input>\n              <sc-input label={__('Password', 'surecart')} type=\"password\" name=\"password\" required></sc-input>\n              <sc-button type=\"primary\" full loading={this.loading} submit>\n                {__('Login', 'surecart')}\n              </sc-button>\n            </sc-form>\n          </sc-dialog>\n        )}\n      </Host>\n    );\n  }\n}\n"]}