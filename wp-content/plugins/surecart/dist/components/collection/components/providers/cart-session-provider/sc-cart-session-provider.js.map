{"version":3,"file":"sc-cart-session-provider.js","sourceRoot":"","sources":["../../../../src/components/providers/cart-session-provider/sc-cart-session-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Element, Event, EventEmitter, h, Listen } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport { state as checkoutState } from '@store/checkout';\n\nimport { updateCheckout } from '../../../services/session';\nimport { Checkout, LineItemData } from '../../../types';\nimport { createErrorNotice, removeNotice } from '@store/notices/mutations';\nimport { updateFormState } from '@store/form/mutations';\nimport { clearCheckout } from '@store/checkout/mutations';\n\n@Component({\n  tag: 'sc-cart-session-provider',\n  shadow: true,\n})\nexport class ScCartSessionProvider {\n  /** Element */\n  @Element() el: HTMLElement;\n\n  /** Set the state */\n  @Event() scSetState: EventEmitter<'loading' | 'busy' | 'navigating' | 'idle'>;\n\n  @Listen('scUpdateOrder')\n  handleUpdateSession(e) {\n    const { data, options } = e.detail;\n    if (options?.silent) {\n      this.update(data);\n    } else {\n      this.loadUpdate(data);\n    }\n  }\n\n  /** Handles coupon updates. */\n  @Listen('scApplyCoupon')\n  async handleCouponApply(e) {\n    const promotion_code = e.detail;\n    removeNotice();\n    this.loadUpdate({\n      discount: {\n        ...(promotion_code ? { promotion_code } : {}),\n      },\n    });\n  }\n\n  /** Handle the error response. */\n  handleErrorResponse(e) {\n    if (e?.code === 'readonly' || e?.additional_errors?.[0]?.code === 'checkout.customer.account_mismatch') {\n      clearCheckout();\n    }\n\n    // expired\n    if (e?.code === 'rest_cookie_invalid_nonce') {\n      updateFormState('EXPIRE');\n      return;\n    }\n\n    // something went wrong\n    if (e?.message) {\n      createErrorNotice(e);\n    }\n\n    // handle curl timeout errors.\n    if (e?.code === 'http_request_failed') {\n      createErrorNotice(__('Something went wrong. Please reload the page and try again.', 'surecart'));\n    }\n  }\n\n  /** Fetch a session. */\n  async fetch(args = {}) {\n    this.loadUpdate({ status: 'draft', ...args });\n  }\n\n  /** Update a the order */\n  async update(data = {}, query = {}) {\n    try {\n      checkoutState.checkout = (await updateCheckout({\n        id: checkoutState.checkout?.id,\n        data: {\n          ...data,\n        },\n        query: {\n          ...query,\n        },\n      })) as Checkout;\n    } catch (e) {\n      console.error(e);\n      throw e;\n    }\n  }\n\n  /** Updates a session with loading status changes. */\n  async loadUpdate(data = {}) {\n    try {\n      updateFormState('FETCH');\n      await this.update(data);\n      updateFormState('RESOLVE');\n    } catch (e) {\n      updateFormState('REJECT');\n      this.handleErrorResponse(e);\n    }\n  }\n\n  render() {\n    return (\n      <sc-line-items-provider order={checkoutState.checkout} onScUpdateLineItems={e => this.loadUpdate({ line_items: e.detail as Array<LineItemData> })}>\n        <slot />\n      </sc-line-items-provider>\n    );\n  }\n}\n"]}