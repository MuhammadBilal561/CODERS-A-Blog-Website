{"version":3,"file":"sc-login-form.js","sourceRoot":"","sources":["../../../../src/components/controllers/login/sc-login-form.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Fragment, h, State, Watch } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '../../../functions/fetch';\nimport { ResponseError, VerificationCode } from '../../../types';\n\n@Component({\n  tag: 'sc-login-form',\n  styleUrl: 'sc-login-form.scss',\n  shadow: true,\n})\nexport class ScLogin {\n  private passwordInput: HTMLScInputElement;\n  private codeInput: HTMLScInputElement;\n\n  @State() step: number = 0;\n  @State() email: string = '';\n  @State() password: string = '';\n  @State() verifyCode: string = '';\n  @State() loading: boolean;\n  @State() error: ResponseError;\n\n  /** Focus the password field automatically on password step. */\n  @Watch('step')\n  handleStepChange() {\n    if (this.step === 1) {\n      setTimeout(() => {\n        this.passwordInput?.triggerFocus?.();\n      }, 50);\n    }\n    if (this.step === 2) {\n      setTimeout(() => {\n        this.codeInput?.triggerFocus?.();\n      }, 50);\n    }\n  }\n\n  /** Clear out error when loading happens. */\n  @Watch('loading')\n  handleLoadingChange(val) {\n    if (val) {\n      this.error = null;\n    }\n  }\n\n  @Watch('verifyCode')\n  handleVerifyCodeChange(val) {\n    if (val?.length >= 6) {\n      this.submitCode();\n    }\n  }\n\n  /** Handle request errors. */\n  handleError(e) {\n    console.error(this.error);\n    this.error = e || { message: __('Something went wrong', 'surecart') };\n  }\n\n  /** Submit for verification codes */\n  async createLoginCode() {\n    try {\n      this.loading = true;\n      await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/verification_codes',\n        data: {\n          login: this.email,\n        },\n      });\n      this.step = this.step + 1;\n    } catch (e) {\n      this.handleError(e);\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  /** Get all subscriptions */\n  async submitCode() {\n    try {\n      this.loading = true;\n      const { verified } = (await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/verification_codes/verify',\n        data: {\n          login: this.email,\n          code: this.verifyCode,\n        },\n      })) as VerificationCode;\n      if (!verified) {\n        throw { message: __('Verification code is not valid. Please try again.', 'surecart') };\n      }\n      window.location.reload();\n    } catch (e) {\n      this.handleError(e);\n      this.loading = false;\n    }\n  }\n\n  async login() {\n    try {\n      this.loading = true;\n      const { redirect_url } = (await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/login',\n        data: {\n          login: this.email,\n          password: this.password,\n        },\n      })) as any;\n      if (redirect_url) {\n        window.location.replace(redirect_url);\n      } else {\n        window.location.reload();\n      }\n    } catch (e) {\n      this.handleError(e);\n      this.loading = false;\n    }\n  }\n\n  async checkEmail() {\n    try {\n      this.loading = true;\n      await apiFetch({\n        method: 'POST',\n        path: 'surecart/v1/check_email',\n        data: {\n          login: this.email,\n        },\n      });\n      this.step = this.step + 1;\n    } catch (e) {\n      this.handleError(e);\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  renderInner() {\n    if (this.step === 2) {\n      return (\n        <Fragment>\n          <div class=\"login-form__title\" part=\"title\">\n            {__('Check your email for a confirmation code', 'surecart')}\n          </div>\n          <div>\n            <sc-form onScFormSubmit={() => this.submitCode()}>\n              <sc-input\n                label={__('Confirmation code', 'surecart')}\n                type=\"text\"\n                ref={el => (this.codeInput = el as HTMLScInputElement)}\n                autofocus\n                required\n                onScInput={e => (this.verifyCode = (e.target as HTMLScInputElement).value)}\n              ></sc-input>\n              <sc-button type=\"primary\" submit full>\n                <sc-icon name=\"lock\" slot=\"prefix\" />\n                {__('Login with Code', 'surecart')}\n              </sc-button>\n            </sc-form>\n          </div>\n        </Fragment>\n      );\n    }\n\n    if (this.step === 1 && this.email) {\n      return (\n        <Fragment>\n          <div class=\"login-form__title\" part=\"title\">\n            <div>{__('Welcome', 'surecart')}</div>\n            <sc-button style={{ fontSize: '18px' }} size=\"small\" pill caret onClick={() => (this.step = this.step - 1)}>\n              <sc-icon name=\"user\" slot=\"prefix\"></sc-icon>\n              {this.email}\n            </sc-button>\n          </div>\n          <sc-flex flexDirection=\"column\" style={{ '--sc-flex-column-gap': 'var(--sc-spacing-large)' }}>\n            <div>\n              <sc-form onScFormSubmit={() => this.createLoginCode()}>\n                <sc-button class=\"login-code\" type=\"primary\" submit full>\n                  <sc-icon name=\"mail\" slot=\"prefix\" />\n                  {__('Send a login code', 'surecart')}\n                </sc-button>\n              </sc-form>\n              <sc-divider style={{ '--spacing': '0.5em' }}>{__('or', 'surecart')}</sc-divider>\n              <sc-form onScFormSubmit={() => this.login()}>\n                <sc-input\n                  label={__('Enter your password', 'surecart')}\n                  type=\"password\"\n                  ref={el => (this.passwordInput = el as HTMLScInputElement)}\n                  onKeyDown={e => e.key === 'Enter' && this.login()}\n                  autofocus\n                  required\n                  onScInput={e => (this.password = (e.target as HTMLScInputElement).value)}\n                ></sc-input>\n                <sc-button type=\"primary\" outline submit full>\n                  <sc-icon name=\"lock\" slot=\"prefix\" />\n                  {__('Login', 'surecart')}\n                </sc-button>\n              </sc-form>\n            </div>\n          </sc-flex>\n        </Fragment>\n      );\n    }\n\n    return (\n      <Fragment>\n        <div class=\"login-form__title\" part=\"title\">\n          <slot name=\"title\"></slot>\n        </div>\n\n        <sc-form onScFormSubmit={() => this.checkEmail()}>\n          <sc-input\n            type=\"text\"\n            value={this.email}\n            label={__('Username or Email Address', 'surecart')}\n            onScInput={e => (this.email = (e.target as HTMLScInputElement).value)}\n            onKeyDown={e => e.key === 'Enter' && this.checkEmail()}\n            required\n            autofocus\n          />\n          <sc-button type=\"primary\" submit full>\n            <sc-icon name=\"arrow-right\" slot=\"suffix\" />\n            {__('Next', 'surecart')}\n          </sc-button>\n        </sc-form>\n      </Fragment>\n    );\n  }\n\n  render() {\n    return (\n      <div class=\"login-form\">\n        <sc-card>\n          {!!this.error && (\n            <sc-alert open type=\"danger\" closable onScHide={() => (this.error = null)}>\n              <span slot=\"title\" innerHTML={this.error?.message}></span>\n              {(this.error?.additional_errors || []).map(({ message }) => (\n                <div innerHTML={message}></div>\n              ))}\n            </sc-alert>\n          )}\n          {this.renderInner()}\n        </sc-card>\n        {this.loading && <sc-block-ui spinner style={{ 'zIndex': '9', '--sc-block-ui-opacity': '0.5' }}></sc-block-ui>}\n      </div>\n    );\n  }\n}\n"]}