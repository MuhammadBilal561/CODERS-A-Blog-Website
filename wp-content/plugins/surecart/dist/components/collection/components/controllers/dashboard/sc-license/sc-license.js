import{Fragment,h}from"@stencil/core";import{onFirstVisible}from"../../../../functions/lazy";import{__}from"@wordpress/i18n";import apiFetch from"../../../../functions/fetch";import{addQueryArgs}from"@wordpress/url";export class ScLicense{constructor(){this.deleteActivation=async()=>{try{this.busy=!0,await apiFetch({path:`surecart/v1/activations/${this.selectedActivationId}`,method:"DELETE"}),this.onCloseDeleteModal(),await this.initialFetch()}catch(e){console.error(e),this.deleteActivationError=(null==e?void 0:e.message)||__("Something went wrong","surecart")}finally{this.busy=!1}},this.onCloseDeleteModal=()=>{this.selectedActivationId="",this.showConfirmDelete=!1,this.busy=!1,this.deleteActivationError=""},this.licenseId=void 0,this.loading=!1,this.error="",this.license=void 0,this.copied=!1,this.showConfirmDelete=!1,this.selectedActivationId="",this.deleteActivationError="",this.busy=!1}componentWillLoad(){onFirstVisible(this.el,(()=>{this.initialFetch()}))}async initialFetch(){try{this.loading=!0,await this.getLicense()}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||__("Something went wrong","surecart")}finally{this.loading=!1}}async getLicense(){this.license=await apiFetch({path:addQueryArgs(`surecart/v1/licenses/${this.licenseId}`,{expand:["activations","purchase","purchase.product"]})})}async copyKey(e){try{await navigator.clipboard.writeText(e),this.copied=!0,setTimeout((()=>{this.copied=!1}),2e3)}catch(e){console.error(e),alert(__("Error copying to clipboard","surecart"))}}renderStatus(){var e,t,s,i;return"active"===(null===(e=this.license)||void 0===e?void 0:e.status)?h("sc-tag",{type:"success"},__("Active","surecart")):"revoked"===(null===(t=this.license)||void 0===t?void 0:t.status)?h("sc-tag",{type:"danger"},__("Revoked","surecart")):"inactive"===(null===(s=this.license)||void 0===s?void 0:s.status)?h("sc-tag",{type:"info"},__("Inactive","surecart")):h("sc-tag",{type:"info"},null===(i=this.license)||void 0===i?void 0:i.status)}renderLoading(){return h("sc-dashboard-module",null,h("span",{slot:"heading"},h("sc-skeleton",{style:{width:"120px"}})),h("sc-card",null,h("sc-stacked-list",null,h("sc-flex",{flexDirection:"column",style:{gap:"1em"}},h("sc-skeleton",{style:{width:"20%",display:"inline-block"}}),h("sc-skeleton",{style:{width:"60%",display:"inline-block"}}),h("sc-skeleton",{style:{width:"40%",display:"inline-block"}})))))}renderEmpty(){return h("sc-empty",{icon:"activity"},__("License not found.","surecart"))}renderLicenseHeader(){var e;const t=null===(e=this.license)||void 0===e?void 0:e.purchase,s=null==t?void 0:t.product;return h(Fragment,null,h("span",{slot:"heading"},h("div",{class:"license__heading"},null==s?void 0:s.name,!this.loading&&!t.live_mode&&h("sc-tag",{type:"warning",size:"small"},__("Test Mode","surecart")))))}renderContent(){var e,t,s,i,n,l,c,o,r,a;return this.loading&&!(null===(e=this.license)||void 0===e?void 0:e.id)?this.renderLoading():(null===(t=this.license)||void 0===t?void 0:t.id)?h(Fragment,null,h("sc-dashboard-module",{error:this.error},this.renderLicenseHeader(),h("sc-card",{noPadding:!0},h("sc-stacked-list",null,h("sc-stacked-list-row",{style:{"--columns":"2","--sc-stacked-list-row-align-items":"center"}},h("div",null,__("License Status","surecart")),this.renderStatus()),h("sc-stacked-list-row",{style:{"--columns":"2"}},h("div",null,__("License Key","surecart")),h("div",{class:"license__key"},h("sc-input",{value:null===(s=this.license)||void 0===s?void 0:s.key,readonly:!0},h("sc-button",{class:"license__copy",type:"default",size:"small",slot:"suffix",onClick:()=>{var e;return this.copyKey(null===(e=this.license)||void 0===e?void 0:e.key)}},this.copied?__("Copied!","surecart"):__("Copy","surecart"))))),h("sc-stacked-list-row",{style:{"--columns":"2"}},h("div",null,__("Date","surecart")),h("sc-format-date",{date:null===(i=this.license)||void 0===i?void 0:i.created_at,type:"timestamp",month:"short",day:"numeric",year:"numeric"})),h("sc-stacked-list-row",{style:{"--columns":"2"}},h("div",null,__("Activations Count","surecart")),h("span",null,null===(n=this.license)||void 0===n?void 0:n.activation_count," / ",(null===(l=this.license)||void 0===l?void 0:l.activation_limit)||h("span",null,"âˆž")))))),h("sc-dashboard-module",null,h("span",{slot:"heading"},h("slot",{name:"heading"},__("Activations","surecart"))),h("sc-card",{noPadding:!0},(null===(r=null===(o=null===(c=this.license)||void 0===c?void 0:c.activations)||void 0===o?void 0:o.data)||void 0===r?void 0:r.length)?h("sc-stacked-list",null,null===(a=this.license)||void 0===a?void 0:a.activations.data.map((e=>h("sc-stacked-list-row",{style:{"--columns":"4"}},h("sc-format-date",{class:"license__date",date:e.created_at,type:"timestamp",month:"short",day:"numeric",year:"numeric"}),h("div",null,e.name),h("div",null,e.fingerprint),h("div",null,h("sc-button",{size:"small",onClick:()=>{this.selectedActivationId=e.id,this.showConfirmDelete=!0}},"Delete")))))):h("sc-empty",null,__("No activations present.","surecart")),this.loading&&h("sc-block-ui",{style:{"--sc-block-ui-opacity":"0.75"},spinner:!0})))):this.renderEmpty()}renderConfirmDelete(){return h("sc-dialog",{open:this.showConfirmDelete,style:{"--body-spacing":"var(--sc-spacing-x-large)"},noHeader:!0,onScRequestClose:this.onCloseDeleteModal},h("sc-button",{class:"close__button",type:"text",circle:!0,onClick:this.onCloseDeleteModal,disabled:this.loading},h("sc-icon",{name:"x"})),h("sc-dashboard-module",{heading:__("Delete Activation","surecart"),class:"license-cancel",error:this.error,style:{"--sc-dashboard-module-spacing":"1em"}},h("span",{slot:"description"},__("Are you sure you want to delete activation?","surecart")),h("sc-flex",{justifyContent:"flex-start"},h("sc-button",{type:"primary",disabled:this.loading||this.busy,onClick:this.deleteActivation},__("Delete Activation","surecart")),h("sc-button",{style:{color:"var(--sc-color-gray-500"},type:"text",onClick:this.onCloseDeleteModal,disabled:this.loading||this.busy},__("Cancel","surecart"))),this.busy&&h("sc-block-ui",{style:{"--sc-block-ui-opacity":"0.75"},spinner:!0})))}render(){return h("sc-spacing",{style:{"--spacing":"var(--sc-spacing-large)"}},this.renderContent(),this.renderConfirmDelete())}static get is(){return"sc-license"}static get encapsulation(){return"shadow"}static get originalStyleUrls(){return{$:["sc-license.scss"]}}static get styleUrls(){return{$:["sc-license.css"]}}static get properties(){return{licenseId:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The license id"},attribute:"license-id",reflect:!1}}}static get states(){return{loading:{},error:{},license:{},copied:{},showConfirmDelete:{},selectedActivationId:{},deleteActivationError:{},busy:{}}}static get elementRef(){return"el"}}