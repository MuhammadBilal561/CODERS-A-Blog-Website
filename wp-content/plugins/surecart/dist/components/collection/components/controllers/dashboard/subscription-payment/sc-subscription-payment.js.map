{"version":3,"file":"sc-subscription-payment.js","sourceRoot":"","sources":["../../../../../src/components/controllers/dashboard/subscription-payment/sc-subscription-payment.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, h, Prop, State, Fragment } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport { addQueryArgs } from '@wordpress/url';\nimport apiFetch from '../../../../functions/fetch';\nimport { PaymentMethod, Subscription, ManualPaymentMethod } from '../../../../types';\n@Component({\n  tag: 'sc-subscription-payment',\n  styleUrl: 'sc-subscription-payment.scss',\n  shadow: true,\n})\nexport class ScSubscriptionPayment {\n  @Prop() subscriptionId: string;\n  @Prop() backUrl: string;\n  @Prop() successUrl: string;\n  @Prop({ mutable: true }) subscription: Subscription;\n  @Prop() paymentMethods: Array<PaymentMethod> = [];\n  @Prop() customerIds: Array<string> = [];\n  @State() manualPaymentMethods: ManualPaymentMethod[];\n  @State() loading: boolean;\n  @State() busy: boolean;\n  @State() error: string;\n\n  componentWillLoad() {\n    this.fetchItems();\n  }\n\n  async fetchItems() {\n    try {\n      this.loading = true;\n      await Promise.all([this.fetchSubscription(), this.fetchPaymentMethods()]);\n    } catch (e) {\n      console.error(e);\n      this.error = e?.message || __('Something went wrong', 'surecart');\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  async fetchSubscription() {\n    if (!this.subscriptionId) return;\n    this.subscription = (await apiFetch({\n      path: addQueryArgs(`/surecart/v1/subscriptions/${this.subscriptionId}`, {\n        expand: ['price', 'price.product', 'current_period', 'product'],\n      }),\n    })) as Subscription;\n  }\n\n  async fetchPaymentMethods() {\n    this.paymentMethods = (await apiFetch({\n      path: addQueryArgs(`/surecart/v1/payment_methods`, {\n        expand: ['card', 'customer', 'billing_agreement', 'paypal_account', 'payment_instrument', 'bank_account'],\n        customer_ids: this.customerIds,\n        reusable: true,\n        ...(this.subscription?.live_mode !== null ? { live_mode: this.subscription.live_mode } : {}),\n      }),\n    })) as PaymentMethod[];\n\n    this.manualPaymentMethods = (await apiFetch({\n      path: addQueryArgs(`surecart/v1/manual_payment_methods`, {\n        customer_ids: this.customerIds,\n        reusable: true,\n        live_mode: this.subscription?.live_mode,\n      }),\n    })) as ManualPaymentMethod[];\n  }\n\n  async handleSubmit(e) {\n    const { payment_method } = await e.target.getFormJson();\n    const isManualPaymentMethod = (this.manualPaymentMethods || []).some(method => method.id === payment_method);\n\n    try {\n      this.error = '';\n      this.busy = true;\n      await apiFetch({\n        path: `/surecart/v1/subscriptions/${this.subscription?.id}`,\n        method: 'PATCH',\n        data: {\n          ...(!isManualPaymentMethod ? { payment_method, manual_payment: false } : { manual_payment_method: payment_method, manual_payment: true }),\n        },\n      });\n      if (this.successUrl) {\n        window.location.assign(this.successUrl);\n      } else {\n        this.busy = false;\n      }\n    } catch (e) {\n      this.error = e?.message || __('Something went wrong', 'surecart');\n      this.busy = false;\n    }\n  }\n\n  renderLoading() {\n    return (\n      <Fragment>\n        <sc-choice name=\"loading\" disabled>\n          <sc-skeleton style={{ width: '60px', display: 'inline-block' }}></sc-skeleton>\n          <sc-skeleton style={{ width: '80px', display: 'inline-block' }} slot=\"price\"></sc-skeleton>\n          <sc-skeleton style={{ width: '120px', display: 'inline-block' }} slot=\"description\"></sc-skeleton>\n        </sc-choice>\n        <sc-button type=\"primary\" full submit loading busy></sc-button>\n        {!!this.backUrl && <sc-button href={this.backUrl} full loading busy></sc-button>}\n      </Fragment>\n    );\n  }\n\n  renderContent() {\n    if (this.loading) {\n      return this.renderLoading();\n    }\n\n    const modeMethods = this.paymentMethods.filter(method => method?.live_mode === this.subscription?.live_mode);\n    const hasNoPaymentMethods = (!this.paymentMethods?.length && !this.manualPaymentMethods?.length) || (this.paymentMethods?.length && !modeMethods?.length);\n    const currentPaymentMethodId = this.subscription?.manual_payment\n      ? this.subscription?.manual_payment_method\n      : (this.subscription?.payment_method as PaymentMethod)?.id || this.subscription?.payment_method;\n\n    if (hasNoPaymentMethods) {\n      return (\n        <Fragment>\n          <sc-empty icon=\"credit-card\">{__('You have no saved payment methods.', 'surecart')}</sc-empty>\n          {!!this.backUrl && (\n            <sc-button href={this.backUrl} full>\n              {__('Go Back', 'surecart')}\n            </sc-button>\n          )}\n        </Fragment>\n      );\n    }\n\n    return (\n      <Fragment>\n        <sc-choices>\n          <div>\n            {(this.paymentMethods || []).map(method => {\n              if (method?.live_mode !== this?.subscription?.live_mode) return null;\n              return (\n                <sc-choice checked={currentPaymentMethodId === method?.id} name=\"payment_method\" value={method?.id}>\n                  <sc-payment-method paymentMethod={method} full={true} />\n                </sc-choice>\n              );\n            })}\n            {(this.manualPaymentMethods || []).map(method => {\n              return (\n                <sc-choice checked={currentPaymentMethodId === method?.id} name=\"payment_method\" value={method?.id}>\n                  <sc-manual-payment-method paymentMethod={method} showDescription />\n                </sc-choice>\n              );\n            })}\n          </div>\n        </sc-choices>\n\n        <sc-button type=\"primary\" full submit loading={this.loading || this.busy} disabled={this.loading || this.busy}>\n          {__('Update', 'surecart')}\n        </sc-button>\n\n        {!!this.backUrl && (\n          <sc-button href={this.backUrl} full loading={this.loading || this.busy} disabled={this.loading || this.busy}>\n            {__('Go Back', 'surecart')}\n          </sc-button>\n        )}\n      </Fragment>\n    );\n  }\n\n  render() {\n    return (\n      <sc-dashboard-module heading={__('Select a payment method', 'surecart')} class=\"subscription-payment\" error={this.error}>\n        <sc-form onScFormSubmit={e => this.handleSubmit(e)}>\n          <sc-card>{this.renderContent()}</sc-card>\n        </sc-form>\n        {this.busy && <sc-block-ui></sc-block-ui>}\n      </sc-dashboard-module>\n    );\n  }\n}\n"]}