import{h,Host}from"@stencil/core";import{__}from"@wordpress/i18n";import{addQueryArgs}from"@wordpress/url";import apiFetch from"../../../../functions/fetch";import{intervalString,translateRemainingPayments}from"../../../../functions/price";import{formatTaxDisplay}from"../../../../functions/tax";export class ScSubscriptionNextPayment{constructor(){this.subscription=void 0,this.updatePaymentMethodUrl=void 0,this.period=void 0,this.loading=!0,this.error=void 0,this.details=void 0}componentWillLoad(){this.fetch()}handleSubscriptionChange(){this.fetch()}async fetch(){var t,e,i;if((null===(t=this.subscription)||void 0===t?void 0:t.cancel_at_period_end)&&this.subscription.current_period_end_at)this.loading=!1;else if("canceled"!==(null===(e=this.subscription)||void 0===e?void 0:e.status))try{this.loading=!0,this.period=await apiFetch({method:"PATCH",path:addQueryArgs(`surecart/v1/subscriptions/${null===(i=this.subscription)||void 0===i?void 0:i.id}/upcoming_period`,{skip_product_group_validation:!0,expand:["period.checkout","checkout.line_items","checkout.payment_method","checkout.manual_payment_method","payment_method.card","payment_method.payment_instrument","payment_method.paypal_account","payment_method.bank_account","line_item.price","price.product","period.subscription"]}),data:{purge_pending_update:!1}})}catch(t){console.error(t),this.error=t}finally{this.loading=!1}else this.loading=!1}render(){var t,e,i,n,r;if(this.loading)return h("sc-toggle",{borderless:!0,disabled:!0},h("sc-flex",{slot:"summary",flexDirection:"column"},h("sc-skeleton",{style:{width:"200px"}}),h("sc-skeleton",{style:{width:"400px"}}),h("sc-skeleton",{style:{width:"300px"}})));const o=null===(t=null==this?void 0:this.period)||void 0===t?void 0:t.checkout;if(!o)return h("div",{style:{padding:"var(--sc-spacing-medium)"}},h("sc-subscription-details",{slot:"summary",subscription:this.subscription}));const s=(null==o?void 0:o.manual_payment)?null==o?void 0:o.manual_payment_method:null,l=(null==this?void 0:this.subscription.payment_method)||(null==this?void 0:this.subscription.manual_payment);return h(Host,null,h("sc-toggle",{borderless:!0,shady:!0},h("span",{slot:"summary"},h("sc-subscription-details",{subscription:this.subscription},h("div",{style:{fontSize:"var(--sc-font-size-small)"}},__("Your next payment is","surecart")," ",h("strong",null,h("sc-format-number",{type:"currency",currency:null==o?void 0:o.currency,value:null==o?void 0:o.amount_due}))," ",!!(null===(e=this.subscription)||void 0===e?void 0:e.finite)&&" â€” "+translateRemainingPayments(null===(i=this.subscription)||void 0===i?void 0:i.remaining_period_count)))),h("sc-card",{noPadding:!0,borderless:!0},null===(n=null==o?void 0:o.line_items)||void 0===n?void 0:n.data.map((t=>{var e,i,n,r,o,s;return h("sc-product-line-item",{imageUrl:null===(i=null===(e=t.price)||void 0===e?void 0:e.product)||void 0===i?void 0:i.image_url,name:null===(r=null===(n=t.price)||void 0===n?void 0:n.product)||void 0===r?void 0:r.name,priceName:null===(o=null==t?void 0:t.price)||void 0===o?void 0:o.name,variantLabel:((null==t?void 0:t.variant_options)||[]).filter(Boolean).join(" / ")||null,editable:!1,removable:!1,quantity:null==t?void 0:t.quantity,amount:null==t?void 0:t.total_amount,currency:null===(s=null==t?void 0:t.price)||void 0===s?void 0:s.currency,interval:intervalString(null==t?void 0:t.price),purchasableStatusDisplay:null==t?void 0:t.purchasable_status_display})})),h("sc-line-item",null,h("span",{slot:"description"},__("Subtotal","surecart")),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:null==o?void 0:o.subtotal_amount})),!!o.proration_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Proration Credit","surecart")),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:-(null==o?void 0:o.proration_amount)})),!!o.applied_balance_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Applied Balance","surecart")),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:-(null==o?void 0:o.applied_balance_amount)})),!!o.trial_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Trial","surecart")),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:null==o?void 0:o.trial_amount})),!!(null==o?void 0:o.discount_amount)&&h("sc-line-item",null,h("span",{slot:"description"},__("Discounts","surecart")),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:null==o?void 0:o.discount_amount})),!!(null==o?void 0:o.shipping_amount)&&h("sc-line-item",{style:{marginTop:"var(--sc-spacing-small)"}},h("span",{slot:"description"},__("Shipping","surecart")),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:null==o?void 0:o.shipping_amount})),!!o.tax_amount&&h("sc-line-item",null,h("span",{slot:"description"},formatTaxDisplay(null==o?void 0:o.tax_label)),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:null==o?void 0:o.tax_amount})),h("sc-divider",{style:{"--spacing":"0"}}),h("sc-line-item",null,h("span",{slot:"description"},__("Payment","surecart")),l&&h("a",{href:this.updatePaymentMethodUrl,slot:"price-description"},h("sc-flex",{"justify-content":"flex-start","align-items":"center",style:{"--spacing":"0.5em"}},s?h("sc-manual-payment-method",{paymentMethod:s}):h("sc-payment-method",{paymentMethod:null==o?void 0:o.payment_method}),h("sc-icon",{name:"edit-3"}))),!l&&h("a",{href:addQueryArgs(window.location.href,{action:"create",model:"payment_method",id:null==this?void 0:this.subscription.id,...!1===(null===(r=null==this?void 0:this.subscription)||void 0===r?void 0:r.live_mode)?{live_mode:!1}:{}}),slot:"price-description"},__("Add Payment Method","surecart"))),h("sc-line-item",{style:{"--price-size":"var(--sc-font-size-x-large)"}},h("span",{slot:"title"},__("Total Due","surecart")),h("sc-format-number",{slot:"price",type:"currency",currency:null==o?void 0:o.currency,value:null==o?void 0:o.amount_due}),h("span",{slot:"currency"},o.currency)))))}static get is(){return"sc-subscription-next-payment"}static get encapsulation(){return"shadow"}static get properties(){return{subscription:{type:"unknown",mutable:!1,complexType:{original:"Subscription",resolved:"Subscription",references:{Subscription:{location:"import",path:"../../../../types"}}},required:!1,optional:!1,docs:{tags:[],text:""}},updatePaymentMethodUrl:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Update the payment method url"},attribute:"update-payment-method-url",reflect:!1}}}static get states(){return{period:{},loading:{},error:{},details:{}}}static get watchers(){return[{propName:"subscription",methodName:"handleSubscriptionChange"}]}}