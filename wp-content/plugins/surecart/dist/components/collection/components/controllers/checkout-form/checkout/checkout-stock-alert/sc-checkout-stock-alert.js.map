{"version":3,"file":"sc-checkout-stock-alert.js","sourceRoot":"","sources":["../../../../../../src/components/controllers/checkout-form/checkout/checkout-stock-alert/sc-checkout-stock-alert.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Host, h, State, EventEmitter, Event } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport { Checkout, LineItemData, Product } from 'src/types';\nimport { state as checkoutState } from '@store/checkout';\nimport { updateCheckout } from '@services/session';\nimport { currentFormState } from '@store/form/getters';\n\n/**\n * This component listens for stock requirements and displays a dialog to the user.\n */\n@Component({\n  tag: 'sc-checkout-stock-alert',\n  styleUrl: 'sc-checkout-stock-alert.scss',\n  shadow: true,\n})\nexport class ScCheckoutStockAlert {\n  /** Stock errors */\n  @State() stockErrors: Array<any> = [];\n\n  /** Toggle line item event */\n  @Event() scUpdateLineItem: EventEmitter<LineItemData>;\n\n  /** Is it busy */\n  @State() busy: boolean;\n\n  /** Update stock error. */\n  @State() error: string;\n\n  /** Get the out of stock line items. */\n  getOutOfStockLineItems() {\n    return (checkoutState.checkout?.line_items?.data || []).filter(lineItem => {\n      const product = lineItem.price?.product as Product;\n\n      // this item is not out of stock, don't include it.\n      if (lineItem?.purchasable_status !== 'out_of_stock') return false;\n\n      // check the variant stock.\n      if (lineItem?.variant?.id) {\n        return lineItem?.variant?.available_stock < lineItem.quantity;\n      }\n\n      return product?.available_stock < lineItem.quantity;\n    });\n  }\n\n  /**\n   * Update the checkout line items stock to the max available.\n   */\n  async onSubmit() {\n    const lineItems = this.getOutOfStockLineItems().map(lineItem => {\n      const product = lineItem.price?.product as Product;\n\n      if (lineItem?.variant?.id) {\n        return {\n          ...lineItem,\n          quantity: Math.max(lineItem?.variant?.available_stock || 0, 0),\n        };\n      }\n\n      return {\n        ...lineItem,\n        quantity: Math.max(product?.available_stock || 0, 0),\n      };\n    });\n\n    try {\n      this.busy = true;\n      checkoutState.checkout = (await updateCheckout({\n        id: checkoutState.checkout.id,\n        data: {\n          line_items: (lineItems || [])\n            .filter(lineItem => !!lineItem.quantity)\n            .map(lineItem => {\n              return {\n                id: lineItem.id,\n                price_id: lineItem.price?.id,\n                quantity: lineItem.quantity,\n                ...(lineItem?.variant?.id ? { variant: lineItem.variant.id } : {}),\n              };\n            }),\n        },\n      })) as Checkout;\n    } catch (error) {\n      const additionalErrors = (error?.additional_errors || []).map(error => error?.message).filter(n => n);\n      this.error = `${error?.message || __('Something went wrong.', 'surecart')} ${additionalErrors?.length && ` ${additionalErrors.join('. ')}`}`;\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  render() {\n    // stock errors.\n    const stockErrors = (this.getOutOfStockLineItems() || []).map(lineItem => {\n      const product = lineItem.price?.product as Product;\n      const variantImage = typeof lineItem?.variant?.image !== 'string' ? lineItem?.variant?.image?.url : null;\n\n      const available_stock = lineItem?.variant?.id ? lineItem?.variant?.available_stock : product?.available_stock;\n\n      return {\n        name: product?.name,\n        image_url: variantImage || product?.image_url,\n        quantity: lineItem.quantity,\n        available_stock,\n      };\n    });\n\n    // we have at least one quantity change.\n    const hasOutOfStockItems = stockErrors?.some(item => item?.available_stock < 1);\n\n    return (\n      <Host>\n        <sc-dialog open={!!stockErrors.length && currentFormState() === 'draft'} noHeader={true} onScRequestClose={e => e.preventDefault()} class=\"stock-alert\">\n          <sc-dashboard-module class=\"subscription-cancel\" error={this.error} style={{ '--sc-dashboard-module-spacing': '1em' }}>\n            <sc-flex slot=\"heading\" align-items=\"center\" justify-content=\"flex-start\">\n              <sc-icon name=\"alert-circle\" style={{ color: 'var(--sc-color-primary-500' }}></sc-icon>\n              {hasOutOfStockItems ? __('Out of Stock', 'surecart') : __('Quantity Update', 'surecart')}\n            </sc-flex>\n            <span slot=\"description\">\n              {hasOutOfStockItems\n                ? __('Some items are no longer available. Your cart will be updated.', 'surecart')\n                : __('Available quantities for these items have changed. Your cart will be updated.', 'surecart')}\n            </span>\n\n            <sc-card no-padding>\n              <sc-table>\n                <sc-table-cell slot=\"head\">{__('Description', 'surecart')}</sc-table-cell>\n                <sc-table-cell slot=\"head\" style={{ width: '100px', textAlign: 'right' }}>\n                  {__('Quantity', 'surecart')}\n                </sc-table-cell>\n\n                {stockErrors.map((item, index) => {\n                  const isLastChild = index === stockErrors.length - 1;\n                  return (\n                    <sc-table-row\n                      style={{\n                        '--columns': '2',\n                        ...(isLastChild ? { border: 'none' } : {}),\n                      }}\n                    >\n                      <sc-table-cell>\n                        <sc-flex justifyContent=\"flex-start\" alignItems=\"center\">\n                          <img class=\"stock-alert__image\" src={`https://surecart.com/cdn-cgi/image/fit=scale-down,format=auto,width=100/${item?.image_url}`} />\n                          <h4>{item.name}</h4>\n                        </sc-flex>\n                      </sc-table-cell>\n                      <sc-table-cell style={{ width: '100px', textAlign: 'right' }}>\n                        <span class=\"stock-alert__quantity\">\n                          <span>{item?.quantity}</span> <sc-icon name=\"arrow-right\" /> <span>{Math.max(item?.available_stock, 0)}</span>\n                        </span>\n                      </sc-table-cell>\n                    </sc-table-row>\n                  );\n                })}\n              </sc-table>\n            </sc-card>\n          </sc-dashboard-module>\n\n          <sc-button slot=\"footer\" type=\"primary\" loading={this.busy} onClick={() => this.onSubmit()}>\n            {__('Continue', 'surecart')}\n            <sc-icon name=\"arrow-right\" slot=\"suffix\" />\n          </sc-button>\n\n          {this.busy && <sc-block-ui spinner></sc-block-ui>}\n        </sc-dialog>\n      </Host>\n    );\n  }\n}\n"]}