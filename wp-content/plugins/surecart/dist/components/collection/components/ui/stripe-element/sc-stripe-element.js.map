{"version":3,"file":"sc-stripe-element.js","sourceRoot":"","sources":["../../../../src/components/ui/stripe-element/sc-stripe-element.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Element, Event, EventEmitter, Fragment, h, Method, Prop, State, Watch } from '@stencil/core';\nimport { loadStripe } from '@stripe/stripe-js/pure';\nimport { __ } from '@wordpress/i18n';\nimport { openWormhole } from 'stencil-wormhole';\nimport { state as selectedProcessor } from '@store/selected-processor';\n\nimport { Checkout, FormState, FormStateSetter, PaymentInfoAddedParams, ProcessorName } from '../../../types';\nimport { availableProcessors } from '@store/processors/getters';\nimport { StripeElementChangeEvent } from '@stripe/stripe-js';\nimport { createErrorNotice } from '@store/notices/mutations';\nimport { updateFormState } from '@store/form/mutations';\n\n@Component({\n  tag: 'sc-stripe-element',\n  styleUrl: 'sc-stripe-element.scss',\n  shadow: false,\n})\nexport class ScStripeElement {\n  @Element() el: HTMLElement;\n  private container: HTMLDivElement;\n  private stripe: any;\n  private elements: any;\n  private element: any;\n\n  /** Whether this field is disabled */\n  @Prop() disabled: boolean;\n\n  /** The checkout session object for finalizing intents */\n  @Prop() order: Checkout;\n\n  /** Mode for the payment */\n  @Prop() mode: 'live' | 'test' = 'live';\n\n  /** The input's size. */\n  @Prop({ reflect: true }) size: 'small' | 'medium' | 'large' = 'medium';\n\n  /** The input's label. Alternatively, you can use the label slot. */\n  @Prop() label: string;\n\n  /** The input's help text. Alternatively, you can use the help-text slot. */\n  @Prop() secureText: string = '';\n\n  /** Should we show the label */\n  @Prop() showLabel: boolean = true;\n\n  /** Inputs focus */\n  @Prop({ mutable: true, reflect: true }) hasFocus: boolean;\n\n  /** The selected processor id */\n  @Prop() selectedProcessorId: ProcessorName;\n\n  /** The form state */\n  @Prop() formState: FormState;\n\n  /** The order/invoice was paid for */\n  @Event() scPaid: EventEmitter<void>;\n  /** Set the state */\n  @Event() scSetState: EventEmitter<FormStateSetter>;\n\n  /** Payment information was added */\n  @Event() scPaymentInfoAdded: EventEmitter<PaymentInfoAddedParams>;\n\n  @State() error: string;\n  @State() confirming: boolean;\n\n  async componentWillLoad() {\n    const processor = (availableProcessors() || []).find(processor => processor.processor_type === 'stripe');\n    if (!processor) {\n      return;\n    }\n    const { account_id, publishable_key } = processor?.processor_data || {};\n    try {\n      this.stripe = await loadStripe(publishable_key, { stripeAccount: account_id });\n      this.elements = this.stripe.elements();\n    } catch (e) {\n      this.error = e?.message || __('Stripe could not be loaded', 'surecart');\n    }\n  }\n\n  /**\n   * Watch order status and maybe confirm the order.\n   */\n  @Watch('formState')\n  async maybeConfirmOrder(val: FormState) {\n    // must be paying\n    if (val !== 'paying') return;\n    // this processor is not selected.\n    if (selectedProcessor?.id !== 'stripe') return;\n    // must be a stripe session\n    if (this.order?.payment_intent?.processor_type !== 'stripe') return;\n    // must have an external intent id\n    if (!this.order?.payment_intent?.external_intent_id) return;\n    // must have a secret\n    if (!this.order?.payment_intent?.processor_data?.stripe?.client_secret) return;\n    // need an external_type\n    if (!this.order?.payment_intent?.processor_data?.stripe?.type) return;\n    // prevent possible double-charges\n    if (this.confirming) return;\n\n    this.confirming = true;\n    try {\n      let response;\n      if (this.order?.payment_intent?.processor_data?.stripe?.type == 'setup') {\n        response = await this.confirmCardSetup(this.order?.payment_intent?.processor_data?.stripe.client_secret);\n      } else {\n        response = await this.confirmCardPayment(this.order?.payment_intent?.processor_data?.stripe?.client_secret);\n      }\n      if (response?.error) {\n        this.error = response.error.message;\n        throw response.error;\n      }\n\n      this.scSetState.emit('PAID');\n      // paid\n      this.scPaid.emit();\n    } catch (e) {\n      updateFormState('REJECT');\n      createErrorNotice(e);\n      if (e.message) {\n        this.error = e.message;\n      }\n      this.confirming = false;\n      this.scSetState.emit('REJECT');\n    }\n  }\n\n  /** Confirm card payment */\n  @Method('confirmPayment')\n  async confirmCardPayment(secret) {\n    return this.stripe.confirmCardPayment(secret, {\n      payment_method: {\n        card: this.element,\n        billing_details: {\n          ...(this?.order?.name ? { name: this.order.name } : {}),\n          ...(this?.order?.email ? { email: this.order.email } : {}),\n        },\n      },\n    });\n  }\n\n  /** Confirm card setup. */\n  @Method('confirmSetup')\n  async confirmCardSetup(secret) {\n    return this.stripe.confirmCardSetup(secret, {\n      payment_method: {\n        card: this.element,\n        billing_details: {\n          ...(this?.order?.name ? { name: this.order.name } : {}),\n          ...(this?.order?.email ? { email: this.order.email } : {}),\n        },\n      },\n    });\n  }\n\n  componentDidLoad() {\n    if (!this.elements) {\n      return;\n    }\n    // get the computed styles.\n    const styles = getComputedStyle(document.body);\n\n    this.elements\n      .create('card', {\n        style: {\n          base: {\n            'color': styles.getPropertyValue('--sc-input-label-color'),\n            'fontSize': '16px',\n            'iconColor': styles.getPropertyValue('--sc-stripe-icon-color'),\n            'fontSmoothing': 'antialiased',\n            '::placeholder': {\n              color: styles.getPropertyValue('--sc-input-placeholder-color'),\n            },\n          },\n          invalid: {\n            'color': styles.getPropertyValue('--sc-color-error-500'),\n            ':focus': {\n              color: styles.getPropertyValue('--sc-input-label-color'),\n            },\n          },\n        },\n      })\n      .mount(this.container);\n\n    this.element = this.elements.getElement('card');\n\n    this.element.on('change', (event: StripeElementChangeEvent) => {\n      if (event.complete) {\n        this.scPaymentInfoAdded.emit({\n          processor_type: 'stripe',\n          checkout_id: this.order.id,\n          currency: this.order.currency,\n          total_amount: this.order.total_amount,\n          line_items: this.order.line_items,\n          payment_method: {\n            billing_details: {\n              name: this?.order?.name ? this.order.name : '',\n              email: this?.order?.email ? this.order.email : '',\n            },\n          },\n        });\n      }\n\n      this.error = event?.error?.message ? event.error.message : '';\n    });\n    this.element.on('focus', () => (this.hasFocus = true));\n    this.element.on('blur', () => (this.hasFocus = false));\n  }\n\n  render() {\n    return (\n      <Fragment>\n        <sc-form-control class=\"sc-stripe\" size={this.size} label={this.label}>\n          <div class=\"sc-stripe-element\" ref={el => (this.container = el as HTMLDivElement)}></div>\n        </sc-form-control>\n        {this.error && (\n          <sc-text\n            style={{\n              'color': 'var(--sc-color-danger-500)',\n              '--font-size': 'var(--sc-font-size-small)',\n              'marginTop': '0.5em',\n            }}\n          >\n            {this.error}\n          </sc-text>\n        )}\n      </Fragment>\n    );\n  }\n}\n\nopenWormhole(ScStripeElement, ['order', 'mode', 'selectedProcessorId', 'formState'], false);\n"]}