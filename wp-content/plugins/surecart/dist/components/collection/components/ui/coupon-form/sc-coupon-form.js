import{h,Fragment}from"@stencil/core";import{speak}from"@wordpress/a11y";import{__,sprintf,_n}from"@wordpress/i18n";import{isRtl}from"../../../functions/page-align";import{getHumanDiscount,getHumanDiscountRedeemableStatus}from"../../../functions/price";export class ScCouponForm{constructor(){this.label=void 0,this.loading=void 0,this.busy=void 0,this.placeholder=void 0,this.error=void 0,this.forceOpen=void 0,this.discount=void 0,this.currency=void 0,this.discountAmount=void 0,this.showInterval=void 0,this.open=void 0,this.collapsed=void 0,this.value=void 0,this.buttonText=void 0}handleOpenChange(e){e&&setTimeout((()=>this.input.triggerFocus()),50)}handleDiscountChange(e,t){var o,s;(null===(o=null==e?void 0:e.promotion)||void 0===o?void 0:o.code)!==(null===(s=null==t?void 0:t.promotion)||void 0===s?void 0:s.code)&&setTimeout((()=>{var e,t;(null===(t=null===(e=null==this?void 0:this.discount)||void 0===e?void 0:e.promotion)||void 0===t?void 0:t.code)?this.couponTag.shadowRoot.querySelector("*").focus():this.addCouponTrigger.focus()}),50)}handleBlur(){this.value||(this.open=!1,this.error="")}getHumanReadableDiscount(){var e,t,o;return(null===(e=null==this?void 0:this.discount)||void 0===e?void 0:e.coupon)&&(null===(t=null==this?void 0:this.discount)||void 0===t?void 0:t.coupon.percent_off)?getHumanDiscount(null===(o=null==this?void 0:this.discount)||void 0===o?void 0:o.coupon):""}applyCoupon(){this.scApplyCoupon.emit(this.input.value.toUpperCase())}handleKeyDown(e){"Enter"===(null==e?void 0:e.code)?this.applyCoupon():"Escape"===(null==e?void 0:e.code)&&(this.scApplyCoupon.emit(null),this.open=!1,speak(__("Coupon code field closed.","surecart"),"assertive"))}translateHumanDiscountWithDuration(e){var t;if(!this.showInterval)return e;const{duration:o,duration_in_months:s}=null===(t=this.discount)||void 0===t?void 0:t.coupon;switch(o){case"once":return`${e} ${__("once","surecart")}`;case"repeating":const t=sprintf(_n("%d month","%d months",s,"surecart"),s);
// translators: %s is the discount amount, %s is the duration (e.g. 3 months)
return sprintf(__("%s for %s","surecart"),e,t);default:return e}}render(){var e,t,o,s,n,r,i,l,a;if(this.loading)return h("sc-skeleton",{style:{width:"120px",display:"inline-block"}});if(null===(t=null===(e=null==this?void 0:this.discount)||void 0===e?void 0:e.promotion)||void 0===t?void 0:t.code){let e=this.getHumanReadableDiscount();return h("sc-line-item",{exportparts:"description:info, price-description:discount, price:amount"},h("span",{slot:"description"},h("div",{part:"discount-label"},__("Discount","surecart")),h("sc-tag",{exportparts:"base:coupon-tag",type:"redeemable"===(null===(o=this.discount)||void 0===o?void 0:o.redeemable_status)?"success":"warning",class:"coupon-tag",clearable:!0,onScClear:()=>{this.scApplyCoupon.emit(null),this.open=!1},onKeyDown:e=>{"Enter"!==e.key&&"Escape"!==e.key||(speak(__("Coupon was removed.","surecart"),"assertive"),this.scApplyCoupon.emit(null),this.open=!1)},ref:e=>this.couponTag=e,role:"button","aria-label":sprintf(__("Press enter to remove coupon code %s.","surecart"),(null===(n=null===(s=null==this?void 0:this.discount)||void 0===s?void 0:s.promotion)||void 0===n?void 0:n.code)||this.input.value||"")},null===(i=null===(r=null==this?void 0:this.discount)||void 0===r?void 0:r.promotion)||void 0===i?void 0:i.code)),"redeemable"===(null===(l=this.discount)||void 0===l?void 0:l.redeemable_status)?h(Fragment,null,e&&h("span",{class:"coupon-human-discount",slot:"price-description"},this.translateHumanDiscountWithDuration(e)),h("span",{slot:"price"},h("sc-format-number",{type:"currency",currency:null==this?void 0:this.currency,value:null==this?void 0:this.discountAmount}))):h("div",{class:"coupon__status",slot:"price-description"},h("sc-icon",{name:"alert-triangle"}),getHumanDiscountRedeemableStatus(null===(a=this.discount)||void 0===a?void 0:a.redeemable_status)))}return this.collapsed?h("div",{part:"base",class:{"coupon-form":!0,"coupon-form--is-open":this.open||this.forceOpen,"coupon-form--has-value":!!this.value,"coupon-form--is-rtl":isRtl()}},h("div",{part:"label",class:"trigger",onMouseDown:()=>{this.open||(this.open=!0)},onKeyDown:e=>{if("Enter"!==e.key&&" "!==e.key)return!0;this.open||(this.open=!0,speak(__("Coupon code field opened. Press Escape button to close it.","surecart"),"assertive"))},tabindex:"0",ref:e=>this.addCouponTrigger=e,role:"button"},h("slot",{name:"label"},this.label)),h("div",{class:"form",part:"form"},h("sc-input",{exportparts:"base:input__base, input, form-control:input__form-control",value:this.value,onScInput:e=>this.value=e.target.value,placeholder:this.placeholder,onScBlur:()=>this.handleBlur(),onKeyDown:e=>this.handleKeyDown(e),ref:e=>this.input=e,"aria-label":__("Add coupon code.","surecart")},h("sc-button",{exportparts:"base:button__base, label:button_label",slot:"suffix",type:"text",loading:this.busy,size:"medium",class:"coupon-button",onClick:()=>this.applyCoupon()},h("slot",null,this.buttonText))),h("sc-button",{exportparts:"base:button__base, label:button_label",type:"primary",outline:!0,loading:this.busy,size:"medium",class:"coupon-button-mobile",onClick:()=>this.applyCoupon()},h("slot",null,this.buttonText)),!!this.error&&h("sc-alert",{exportparts:"base:error__base, icon:error__icon, text:error__text, title:error_title, message:error__message",type:"danger",open:!0},h("span",{slot:"title"},this.error))),this.loading&&h("sc-block-ui",{exportparts:"base:block-ui, content:block-ui__content"})):h("div",{class:{"coupon-form":!0,"coupon-form--has-value":!!this.value,"coupon-form--is-rtl":isRtl()}},h("sc-input",{label:this.label,exportparts:"base:input__base, input, form-control:input__form-control",value:this.value,onScInput:e=>this.value=e.target.value,placeholder:this.placeholder,onScBlur:()=>this.handleBlur(),onKeyDown:e=>this.handleKeyDown(e),ref:e=>this.input=e},h("sc-button",{exportparts:"base:button__base, label:button_label",slot:"suffix",type:"text",loading:this.busy,size:"medium",class:"coupon-button",onClick:()=>this.applyCoupon()},h("slot",null,this.buttonText))),h("sc-button",{exportparts:"base:button__base, label:button_label",type:"primary",outline:!0,loading:this.busy,size:"medium",class:"coupon-button-mobile",onClick:()=>this.applyCoupon()},h("slot",null,this.buttonText)),!!this.error&&h("sc-alert",{exportparts:"base:error__base, icon:error__icon, text:error__text, title:error_title, message:error__message",type:"danger",open:!0},h("span",{slot:"title"},this.error)))}static get is(){return"sc-coupon-form"}static get encapsulation(){return"shadow"}static get originalStyleUrls(){return{$:["sc-coupon-form.scss"]}}static get styleUrls(){return{$:["sc-coupon-form.css"]}}static get properties(){return{label:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The label for the coupon form"},attribute:"label",reflect:!1},loading:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Is the form loading"},attribute:"loading",reflect:!1},busy:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Is the form calculating"},attribute:"busy",reflect:!1},placeholder:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The placeholder for the input"},attribute:"placeholder",reflect:!1},error:{type:"string",mutable:!0,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The error message"},attribute:"error",reflect:!1},forceOpen:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Force the form to show"},attribute:"force-open",reflect:!1},discount:{type:"unknown",mutable:!1,complexType:{original:"DiscountResponse",resolved:"DiscountResponse",references:{DiscountResponse:{location:"import",path:"../../../types"}}},required:!1,optional:!1,docs:{tags:[],text:"The discount"}},currency:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Currency"},attribute:"currency",reflect:!1},discountAmount:{type:"number",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The discount amount"},attribute:"discount-amount",reflect:!1},showInterval:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Has recurring"},attribute:"show-interval",reflect:!1},open:{type:"boolean",mutable:!0,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Is it open"},attribute:"open",reflect:!1},collapsed:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"collapsed",reflect:!1},buttonText:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The text for apply button"},attribute:"button-text",reflect:!0}}}static get states(){return{value:{}}}static get events(){return[{method:"scApplyCoupon",name:"scApplyCoupon",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:"When the coupon is applied"},complexType:{original:"string",resolved:"string",references:{}}}]}static get watchers(){return[{propName:"open",methodName:"handleOpenChange"},{propName:"discount",methodName:"handleDiscountChange"}]}}