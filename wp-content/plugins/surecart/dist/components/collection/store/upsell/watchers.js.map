{"version":3,"file":"watchers.js","sourceRoot":"","sources":["../../../src/store/upsell/watchers.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,EAAE,YAAY,EAAE,MAAM,gBAAgB,CAAC;AAC9C,OAAO,EAAE,EAAE,EAAE,MAAM,YAAY,CAAC;AAChC,OAAO,EAAE,UAAU,EAAE,eAAe,EAAE,MAAM,WAAW,CAAC;AACxD,OAAO,EAAE,OAAO,EAAE,MAAM,aAAa,CAAC;AACtC,OAAO,KAAK,EAAE,EAAE,QAAQ,EAAE,MAAM,SAAS,CAAC;AAE1C;;GAEG;AACH,EAAE,CAAC,KAAK,EAAE,CAAC,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,EAAE;EAClC,IAAI,IAAI,CAAC,SAAS,CAAC,QAAQ,aAAR,QAAQ,uBAAR,QAAQ,CAAE,SAAS,CAAC,KAAK,IAAI,CAAC,SAAS,CAAC,QAAQ,aAAR,QAAQ,uBAAR,QAAQ,CAAE,SAAS,CAAC,EAAE;IAC/E,OAAO,EAAE,CAAC;GACX;AACH,CAAC,CAAC,CAAC;AAEH;;GAEG;AACH,WAAW,CAAC,GAAG,EAAE;EACf,IAAI,eAAe,EAAE,EAAE;IACrB,KAAK,CAAC,OAAO,GAAG,UAAU,CAAC;GAC5B;AACH,CAAC,EAAE,IAAI,CAAC,CAAC;AAET;;GAEG;AACH,QAAQ,CAAC,WAAW,EAAE,GAAG,EAAE;;EACzB,KAAK,CAAC,UAAU,GAAG,CAAA,MAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,SAAS,0CAAE,YAAY,IAAG,CAAC,MAAA,MAAA,KAAK,aAAL,KAAK,uBAAL,KAAK,CAAE,SAAS,0CAAE,YAAY,mCAAI,CAAC,CAAC,CAAC;AAC5F,CAAC,CAAC,CAAC;AAEH;;GAEG;AACH,QAAQ,CAAC,QAAQ,EAAE,GAAG,CAAC,EAAE;;EACvB,aAAa;EACb,IAAI,CAAC,CAAA,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,SAAS,CAAA,EAAE;IACnB,OAAO,CAAC,KAAK,CAAC,OAAO,GAAG,UAAU,CAAC,CAAC;GACrC;EAED,2BAA2B;EAC3B,KAAK,CAAC,OAAO,GAAG,aAAa,CAAC;EAC9B,MAAM,CAAC,QAAQ,CAAC,MAAM,CACpB,YAAY,CAAC,GAAG,aAAH,GAAG,uBAAH,GAAG,CAAE,SAAS,EAAE;IAC3B,cAAc,EAAE,MAAA,KAAK,CAAC,QAAQ,0CAAE,EAAE;IAClC,UAAU,EAAE,KAAK,CAAC,OAAO;GAC1B,CAAC,CACH,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH;;GAEG;AACH,QAAQ,CAAC,SAAS,EAAE,GAAG,CAAC,EAAE;;EACxB,IAAI,GAAG,KAAK,UAAU,EAAE;IACtB,MAAM,QAAQ,GAAG,UAAU,EAAE,CAAC;IAC9B,IAAI,CAAC,QAAQ,EAAE;MACb,OAAO,CAAC,KAAK,CAAC,OAAO,GAAG,UAAU,CAAC,CAAC;KACrC;IACD,KAAK,CAAC,OAAO,GAAG,aAAa,CAAC;IAC9B,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,CAAC,QAAQ,EAAE,EAAE,QAAQ,EAAE,MAAA,KAAK,CAAC,QAAQ,0CAAE,EAAE,EAAE,CAAC,CAAC,CAAC;GAClF;AACH,CAAC,CAAC,CAAC","sourcesContent":["/**\n * Internal dependencies.\n */\nimport { addQueryArgs } from '@wordpress/url';\nimport { on } from '../product';\nimport { getExitUrl, isUpsellExpired } from './getters';\nimport { preview } from './mutations';\nimport state, { onChange } from './store';\n\n/**\n * When line item changes, update totals.\n */\non('set', (_, newValue, oldValue) => {\n  if (JSON.stringify(newValue?.line_item) !== JSON.stringify(oldValue?.line_item)) {\n    preview();\n  }\n});\n\n/**\n * Watch for upsell to expire every second.\n */\nsetInterval(() => {\n  if (isUpsellExpired()) {\n    state.loading = 'complete';\n  }\n}, 1000);\n\n/**\n * Dynamically update amount_due when line_item changes.\n */\nonChange('line_item', () => {\n  state.amount_due = state?.line_item?.total_amount + (state?.line_item?.trial_amount ?? 0);\n});\n\n/**\n * When the upsell changes, complete or redirect.\n */\nonChange('upsell', val => {\n  // completed.\n  if (!val?.permalink) {\n    return (state.loading = 'complete');\n  }\n\n  // redirect to next upsell.\n  state.loading = 'redirecting';\n  window.location.assign(\n    addQueryArgs(val?.permalink, {\n      sc_checkout_id: state.checkout?.id,\n      sc_form_id: state.form_id,\n    }),\n  );\n});\n\n/**\n * When the loading state changes, redirect if complete.\n */\nonChange('loading', val => {\n  if (val === 'complete') {\n    const nextLink = getExitUrl();\n    if (!nextLink) {\n      return (state.loading = 'complete');\n    }\n    state.loading = 'redirecting';\n    window.location.assign(addQueryArgs(nextLink, { sc_order: state.checkout?.id }));\n  }\n});\n"]}