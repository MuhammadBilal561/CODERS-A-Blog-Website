{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/services/session/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { state as checkoutState } from '@store/checkout';\nimport { addQueryArgs, getQueryArg } from '@wordpress/url';\n\nimport apiFetch from '../../functions/fetch';\nimport { Checkout, DeletedItem, LineItem } from '../../types';\nimport { __ } from '@wordpress/i18n';\n\n/** The base url for this service. */\nexport const baseUrl = 'surecart/v1/checkouts/';\n\n/** Items to always expand. */\nexport const expand = [\n  'line_items',\n  'line_item.price',\n  'line_item.fees',\n  'line_item.variant',\n  'variant.image',\n  'price.product',\n  'product.featured_product_media',\n  'product.product_collections',\n  'product_media.media',\n  'customer',\n  'customer.shipping_address',\n  'payment_intent',\n  'discount',\n  'discount.promotion',\n  'recommended_bumps',\n  'bump.price',\n  'current_upsell',\n  'product.variants',\n  'discount.coupon',\n  'shipping_address',\n  'billing_address',\n  'tax_identifier',\n  'manual_payment_method',\n  'shipping_choices',\n  'shipping_choice.shipping_method',\n];\n\n/** Default data we send with every request. */\nexport const withDefaultData = (data: { metadata?: any } = {}) => ({\n  live_mode: checkoutState.mode !== 'test',\n  group_key: checkoutState.groupId,\n  abandoned_checkout_enabled: checkoutState.abandonedCheckoutEnabled,\n  billing_matches_shipping: checkoutState.checkout?.billing_matches_shipping,\n  metadata: {\n    ...(data?.metadata || {}),\n    ...(window?.scData?.page_id && { page_id: window?.scData?.page_id }),\n    ...(checkoutState?.product?.id && { buy_page_product_id: checkoutState?.product?.id }),\n    page_url: window.location.href,\n  },\n  ...(checkoutState?.checkout?.email && { email: checkoutState?.checkout?.email }),\n  ...data,\n});\n\n/** Default query we send with every request. */\nexport const withDefaultQuery = (query = {}) => ({\n  ...(!!checkoutState?.formId && { form_id: checkoutState?.formId }),\n  ...(!!checkoutState?.product?.id && { product_id: checkoutState?.product?.id }),\n  ...query,\n});\n\n/** Get the checkout id  */\nexport const findInitialCheckoutId = () => {\n  // check url first.\n  const checkoutId = getQueryArg(window.location.href, 'checkout_id');\n  if (!!checkoutId) {\n    return checkoutId;\n  }\n\n  // check existing order.\n  if (checkoutState?.checkout?.id) {\n    return checkoutState?.checkout?.id;\n  }\n\n  // we don't have and order id.\n  return null;\n};\n\n/** Parse the path with expansions. */\nexport const parsePath = (id, endpoint = '') => {\n  let path = id ? `${baseUrl}${id}` : baseUrl;\n  path = `${path}${endpoint}`;\n  return addQueryArgs(path, {\n    expand,\n  });\n};\n\n/** Fethc a checkout by id */\nexport const fetchCheckout = async ({ id, query = {} }) => {\n  return (await apiFetch({\n    path: addQueryArgs(parsePath(id), withDefaultQuery(query)),\n  })) as Checkout;\n};\n\n/** Create or update the checkout. */\nexport const createOrUpdateCheckout = async ({ id = null, data = {}, query = {} }) => {\n  id = !id ? findInitialCheckoutId() : id;\n  return await apiFetch({\n    method: id ? 'PATCH' : 'POST', // create or update\n    path: addQueryArgs(parsePath(id), withDefaultQuery(query)),\n    data: withDefaultData(data),\n  });\n};\n\n/** Create the checkout */\nexport const createCheckout = async ({ data = {}, query = {} }) => {\n  return await apiFetch({\n    method: 'POST', // create\n    path: addQueryArgs(parsePath(null), withDefaultQuery(query)),\n    data: withDefaultData(data),\n  });\n};\n\n/** Update the checkout. */\nexport const updateCheckout = async ({ id, data = {}, query = {} }) => {\n  return await apiFetch({\n    method: 'PATCH',\n    path: addQueryArgs(parsePath(id), withDefaultQuery(query)),\n    data: withDefaultData(data),\n  });\n};\n\n/** Finalize a checkout */\nexport const finalizeCheckout = async ({ id, data = {}, query = {}, processor }: { id: string; data?: any; query?: any; processor: { id: string; manual: boolean } }) => {\n  return (await apiFetch({\n    method: 'POST',\n    path: addQueryArgs(\n      parsePath(id, '/finalize'),\n      withDefaultQuery({\n        ...(processor?.manual ? { manual_payment: true, manual_payment_method_id: processor?.id } : { processor_type: processor?.id }),\n        ...query,\n      }),\n    ),\n    data: withDefaultData(data),\n  })) as Checkout;\n};\n\n/**\n * Add a line item.\n */\nexport const addLineItem = async ({ checkout, data, live_mode = false }) => {\n  const existingLineItem = (checkout?.line_items?.data || []).find(item => {\n    if (!item?.variant?.id) {\n      return item.price.id === data.price;\n    }\n    return item.variant.id === data.variant && item.price.id === data.price;\n  });\n\n  // create the checkout with the line item.\n  if (!checkout?.id) {\n    return (await apiFetch({\n      method: 'POST', // create\n      path: addQueryArgs(parsePath(null)),\n      data: {\n        line_items: [data],\n        live_mode,\n      },\n    })) as Checkout;\n  }\n\n  // handle existing line item.\n  if (!!existingLineItem) {\n    return await updateLineItem({ id: existingLineItem?.id, data: { ...data, quantity: existingLineItem?.quantity + data?.quantity } });\n  }\n\n  const item = (await apiFetch({\n    path: addQueryArgs(`surecart/v1/line_items/${existingLineItem?.id ? existingLineItem?.id : ''}`, {\n      consolidate: true,\n      expand: [\n        ...(expand || []).map(item => {\n          return item.includes('.') ? item : `checkout.${item}`;\n        }),\n        'checkout',\n      ],\n    }),\n    method: 'POST',\n    data: {\n      ...data,\n      checkout: checkout.id,\n    },\n  })) as LineItem;\n\n  return item?.checkout as Checkout;\n};\n\n/**\n * Remove a line item.\n */\nexport const removeLineItem = async ({ checkoutId, itemId }) => {\n  const { deleted } = (await apiFetch({\n    path: `surecart/v1/line_items/${itemId}`,\n    method: 'DELETE',\n  })) as DeletedItem;\n\n  if (!deleted) {\n    throw { code: 'error', message: __('Failed to delete', 'surecart') };\n  }\n\n  return await fetchCheckout({ id: checkoutId });\n};\n\n/**\n * Update a line item.\n */\nexport const updateLineItem = async ({ id, data }) => {\n  const item = (await apiFetch({\n    path: addQueryArgs(`surecart/v1/line_items/${id}`, {\n      expand: [\n        ...(expand || []).map(item => {\n          return item.includes('.') ? item : `checkout.${item}`;\n        }),\n        'checkout',\n      ],\n    }),\n    method: 'PATCH',\n    data,\n  })) as LineItem;\n\n  return item?.checkout as Checkout;\n};\n"]}