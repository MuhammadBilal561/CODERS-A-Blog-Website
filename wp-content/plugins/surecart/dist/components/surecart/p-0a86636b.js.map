{"version":3,"names":["on","_","newValue","oldValue","JSON","stringify","line_item","preview","setInterval","isUpsellExpired","state","loading","onChange","amount_due","_a","total_amount","_c","_b","trial_amount","val","permalink","window","location","assign","addQueryArgs","sc_checkout_id","checkout","id","sc_form_id","form_id","nextLink","getExitUrl","sc_order"],"sources":["./src/store/upsell/watchers.ts"],"sourcesContent":["/**\n * Internal dependencies.\n */\nimport { addQueryArgs } from '@wordpress/url';\nimport { on } from '../product';\nimport { getExitUrl, isUpsellExpired } from './getters';\nimport { preview } from './mutations';\nimport state, { onChange } from './store';\n\n/**\n * When line item changes, update totals.\n */\non('set', (_, newValue, oldValue) => {\n  if (JSON.stringify(newValue?.line_item) !== JSON.stringify(oldValue?.line_item)) {\n    preview();\n  }\n});\n\n/**\n * Watch for upsell to expire every second.\n */\nsetInterval(() => {\n  if (isUpsellExpired()) {\n    state.loading = 'complete';\n  }\n}, 1000);\n\n/**\n * Dynamically update amount_due when line_item changes.\n */\nonChange('line_item', () => {\n  state.amount_due = state?.line_item?.total_amount + (state?.line_item?.trial_amount ?? 0);\n});\n\n/**\n * When the upsell changes, complete or redirect.\n */\nonChange('upsell', val => {\n  // completed.\n  if (!val?.permalink) {\n    return (state.loading = 'complete');\n  }\n\n  // redirect to next upsell.\n  state.loading = 'redirecting';\n  window.location.assign(\n    addQueryArgs(val?.permalink, {\n      sc_checkout_id: state.checkout?.id,\n      sc_form_id: state.form_id,\n    }),\n  );\n});\n\n/**\n * When the loading state changes, redirect if complete.\n */\nonChange('loading', val => {\n  if (val === 'complete') {\n    const nextLink = getExitUrl();\n    if (!nextLink) {\n      return (state.loading = 'complete');\n    }\n    state.loading = 'redirecting';\n    window.location.assign(addQueryArgs(nextLink, { sc_order: state.checkout?.id }));\n  }\n});\n"],"mappings":"kMAYAA,EAAG,OAAO,CAACC,EAAGC,EAAUC,KACtB,GAAIC,KAAKC,UAAUH,IAAQ,MAARA,SAAQ,SAARA,EAAUI,aAAeF,KAAKC,UAAUF,IAAQ,MAARA,SAAQ,SAARA,EAAUG,WAAY,CAC/EC,G,KAOJC,aAAY,KACV,GAAIC,IAAmB,CACrBC,EAAMC,QAAU,U,IAEjB,KAKHC,EAAS,aAAa,K,UACpBF,EAAMG,aAAaC,EAAAJ,IAAK,MAALA,SAAK,SAALA,EAAOJ,aAAS,MAAAQ,SAAA,SAAAA,EAAEC,gBAAgBC,GAAAC,EAAAP,IAAK,MAALA,SAAK,SAALA,EAAOJ,aAAS,MAAAW,SAAA,SAAAA,EAAEC,gBAAY,MAAAF,SAAA,EAAAA,EAAI,EAAE,IAM3FJ,EAAS,UAAUO,I,MAEjB,KAAKA,IAAG,MAAHA,SAAG,SAAHA,EAAKC,WAAW,CACnB,OAAQV,EAAMC,QAAU,U,CAI1BD,EAAMC,QAAU,cAChBU,OAAOC,SAASC,OACdC,EAAaL,IAAG,MAAHA,SAAG,SAAHA,EAAKC,UAAW,CAC3BK,gBAAgBX,EAAAJ,EAAMgB,YAAQ,MAAAZ,SAAA,SAAAA,EAAEa,GAChCC,WAAYlB,EAAMmB,UAErB,IAMHjB,EAAS,WAAWO,I,MAClB,GAAIA,IAAQ,WAAY,CACtB,MAAMW,EAAWC,IACjB,IAAKD,EAAU,CACb,OAAQpB,EAAMC,QAAU,U,CAE1BD,EAAMC,QAAU,cAChBU,OAAOC,SAASC,OAAOC,EAAaM,EAAU,CAAEE,UAAUlB,EAAAJ,EAAMgB,YAAQ,MAAAZ,SAAA,SAAAA,EAAEa,K"}