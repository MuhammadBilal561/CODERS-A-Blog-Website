import{r as i,c as o,h as t,a as d}from"./p-cc7ce8c7.js";import{p as l}from"./p-f0bb2283.js";import{s,o as n}from"./p-24f06282.js";import{c as e,f as v}from"./p-5ec5df35.js";import{c as a}from"./p-8266bbed.js";import{o as u}from"./p-2f9b1dd9.js";import"./p-112455b1.js";import"./p-25433d0f.js";import"./p-f70181c4.js";import"./p-4d73f82a.js";import"./p-1c2e2695.js";import"./p-830ab1a3.js";import"./p-a3a138d6.js";import"./p-7ef0f71c.js";import"./p-50da3ba3.js";import"./p-18e45a13.js";const r=":host{display:block}.or{display:none;margin:var(--sc-form-section-spacing) 0}.request--loaded .or{display:block}";const h=class{constructor(t){i(this,t);this.scFormSubmit=o(this,"scFormSubmit",7);this.scPaid=o(this,"scPaid",7);this.scPayError=o(this,"scPayError",7);this.scSetState=o(this,"scSetState",7);this.scPaymentRequestLoaded=o(this,"scPaymentRequestLoaded",7);this.scUpdateOrderState=o(this,"scUpdateOrderState",7);this.stripeAccountId=undefined;this.publishableKey=undefined;this.country="US";this.prices=undefined;this.label="total";this.amount=0;this.theme="dark";this.error=undefined;this.debug=false;this.loaded=false;this.debugError=undefined}async componentWillLoad(){if(!(this===null||this===void 0?void 0:this.publishableKey)||!(this===null||this===void 0?void 0:this.stripeAccountId)){return true}try{this.stripe=await l.loadStripe(this.publishableKey,{stripeAccount:this.stripeAccountId});this.elements=this.stripe.elements();this.paymentRequest=this.stripe.paymentRequest({country:this.country,requestShipping:true,requestPayerEmail:true,shippingOptions:[{id:"free",label:"Free Shipping",detail:"No shipping required",amount:0}],...this.getRequestObject(s===null||s===void 0?void 0:s.checkout)})}catch(i){console.log((i===null||i===void 0?void 0:i.message)||wp.i18n.__("Stripe could not be loaded","surecart"))}}handleOrderChange(){if(!this.paymentRequest)return;if(this.pendingEvent)return;this.paymentRequest.update(this.getRequestObject(s===null||s===void 0?void 0:s.checkout))}handleLoaded(){this.scPaymentRequestLoaded.emit(true)}handleErrorChange(){if(this.pendingEvent){this.pendingEvent.complete("error")}}async handleShippingChange(i){var o,t,d,l,n;const{shippingAddress:v,updateWith:a}=i;try{const i=await e({id:(o=s===null||s===void 0?void 0:s.checkout)===null||o===void 0?void 0:o.id,data:{shipping_address:{...(v===null||v===void 0?void 0:v.name)?{name:v===null||v===void 0?void 0:v.name}:{},...((t=v===null||v===void 0?void 0:v.addressLine)===null||t===void 0?void 0:t[0])?{line_1:(d=v===null||v===void 0?void 0:v.addressLine)===null||d===void 0?void 0:d[0]}:{},...((l=v===null||v===void 0?void 0:v.addressLine)===null||l===void 0?void 0:l[1])?{line_2:(n=v===null||v===void 0?void 0:v.addressLine)===null||n===void 0?void 0:n[1]}:{},...(v===null||v===void 0?void 0:v.city)?{city:v===null||v===void 0?void 0:v.city}:{},...(v===null||v===void 0?void 0:v.country)?{country:v===null||v===void 0?void 0:v.country}:{},...(v===null||v===void 0?void 0:v.postalCode)?{postal_code:v===null||v===void 0?void 0:v.postalCode}:{},...(v===null||v===void 0?void 0:v.region)?{state:v===null||v===void 0?void 0:v.region}:{}}}});a({status:"success",total:{amount:(i===null||i===void 0?void 0:i.amount_due)||0,label:wp.i18n.__("Total","surecart"),pending:true}})}catch(i){i.updateWith({status:"invalid_shipping_address"})}}getName(i){var o,t,d,l,s;const n=Object.keys(this.prices||{}).filter((o=>{const t=this.prices[o];return t.product===i.price.product.id}));let e="";if(n.length>1){e=`${(t=(o=i===null||i===void 0?void 0:i.price)===null||o===void 0?void 0:o.product)===null||t===void 0?void 0:t.name} â€“ ${(d=i===null||i===void 0?void 0:i.price)===null||d===void 0?void 0:d.name}`}else{e=(s=(l=i===null||i===void 0?void 0:i.price)===null||l===void 0?void 0:l.product)===null||s===void 0?void 0:s.name}return e}getRequestObject(i){var o;const t=(((o=i===null||i===void 0?void 0:i.line_items)===null||o===void 0?void 0:o.data)||[]).map((i=>({label:this.getName(i),amount:i.ad_hoc_amount!==null?i.ad_hoc_amount:i.subtotal_amount})));return{currency:s.currencyCode,total:{amount:(i===null||i===void 0?void 0:i.amount_due)||0,label:wp.i18n.__("Total","surecart"),pending:true},displayItems:t}}componentDidLoad(){this.handleOrderChange();this.removeCheckoutListener=n("checkout",(()=>this.handleOrderChange()));if(!this.elements){return}const i=this.elements.create("paymentRequestButton",{paymentRequest:this.paymentRequest,style:{paymentRequestButton:{theme:this.theme}}});this.paymentRequest.on("paymentmethod",(i=>this.handlePaymentMethod(i)));this.paymentRequest.on("shippingaddresschange",(async i=>await this.handleShippingChange(i)));this.paymentRequest.canMakePayment().then((o=>{if(!o){if(location.protocol!=="https:"){if(this.debug){this.debugError=wp.i18n.__("You must serve this page over HTTPS to display express payment buttons.","surecart")}console.log("SSL needed to display payment buttons.")}else{if(this.debug){this.debugError=wp.i18n.__("You do not have any wallets set up in your browser.","surecart")}console.log("No wallets available.")}return}i.mount(this.request);this.loaded=true})).catch((i=>{console.error(i)}))}async handlePaymentMethod(i){var o,t,d,l,n;const{billing_details:u}=i===null||i===void 0?void 0:i.paymentMethod;const{shippingAddress:r}=i;try{this.scSetState.emit("FINALIZE");await e({id:(o=s===null||s===void 0?void 0:s.checkout)===null||o===void 0?void 0:o.id,data:{email:u===null||u===void 0?void 0:u.email,name:u===null||u===void 0?void 0:u.name,shipping_address:{...(r===null||r===void 0?void 0:r.name)?{name:r===null||r===void 0?void 0:r.name}:{},...((t=r===null||r===void 0?void 0:r.addressLine)===null||t===void 0?void 0:t[0])?{line_1:(d=r===null||r===void 0?void 0:r.addressLine)===null||d===void 0?void 0:d[0]}:{},...((l=r===null||r===void 0?void 0:r.addressLine)===null||l===void 0?void 0:l[1])?{line_2:(n=r===null||r===void 0?void 0:r.addressLine)===null||n===void 0?void 0:n[1]}:{},...(r===null||r===void 0?void 0:r.city)?{city:r===null||r===void 0?void 0:r.city}:{},...(r===null||r===void 0?void 0:r.country)?{country:r===null||r===void 0?void 0:r.country}:{},...(r===null||r===void 0?void 0:r.postalCode)?{postal_code:r===null||r===void 0?void 0:r.postalCode}:{},...(r===null||r===void 0?void 0:r.region)?{state:r===null||r===void 0?void 0:r.region}:{}}}});const a=await v({id:s===null||s===void 0?void 0:s.checkout.id,query:{form_id:s.formId},processor:{id:"stripe",manual:false}});this.scSetState.emit("PAYING");await this.confirmPayment(a,i);this.scSetState.emit("PAID");this.scPaid.emit();i.complete("success")}catch(o){console.error(o);this.scPayError.emit(o);a(o);i.complete("fail")}finally{this.confirming=false}}async confirmPayment(i,o){var t,d,l,s,n,e,v,a,u,r,h,p,c,m,f,y,b,g;if((i===null||i===void 0?void 0:i.status)!=="finalized")return;if(!((l=(d=(t=i===null||i===void 0?void 0:i.payment_intent)===null||t===void 0?void 0:t.processor_data)===null||d===void 0?void 0:d.stripe)===null||l===void 0?void 0:l.client_secret))return;if(!((e=(n=(s=i===null||i===void 0?void 0:i.payment_intent)===null||s===void 0?void 0:s.processor_data)===null||n===void 0?void 0:n.stripe)===null||e===void 0?void 0:e.type))return;if(!((v=i===null||i===void 0?void 0:i.payment_intent)===null||v===void 0?void 0:v.external_intent_id))return;if(this.confirming)return;this.confirming=true;let w;if(((r=(u=(a=i===null||i===void 0?void 0:i.payment_intent)===null||a===void 0?void 0:a.processor_data)===null||u===void 0?void 0:u.stripe)===null||r===void 0?void 0:r.type)=="setup"){w=await this.confirmCardSetup((p=(h=i===null||i===void 0?void 0:i.payment_intent)===null||h===void 0?void 0:h.processor_data)===null||p===void 0?void 0:p.stripe.client_secret,o)}else{w=await this.confirmCardPayment((m=(c=i===null||i===void 0?void 0:i.payment_intent)===null||c===void 0?void 0:c.processor_data)===null||m===void 0?void 0:m.stripe.client_secret,o)}if(w===null||w===void 0?void 0:w.error){throw w.error}if(((f=w===null||w===void 0?void 0:w.paymentIntent)===null||f===void 0?void 0:f.status)==="requires_action"||((y=w===null||w===void 0?void 0:w.paymentIntent)===null||y===void 0?void 0:y.status)==="requires_source_action"){const o=await this.stripe.confirmCardPayment((g=(b=i===null||i===void 0?void 0:i.payment_intent)===null||b===void 0?void 0:b.processor_data)===null||g===void 0?void 0:g.stripe.client_secret);if(o.error){throw o.error}return o}return w}confirmCardPayment(i,o){return this.stripe.confirmCardPayment(i,{payment_method:o.paymentMethod.id},{handleActions:false})}confirmCardSetup(i,o){return this.stripe.confirmCardSetup(i,{payment_method:o.paymentMethod.id},{handleActions:false})}disconnectedCallback(){this.removeCheckoutListener()}render(){return t("div",{class:{request:true,"request--loaded":this.loaded}},this.debug&&this.debugError&&t("div",null,t("slot",{name:"debug-fallback"}),t("sc-alert",{type:"info",open:true},t("span",{slot:"title"},wp.i18n.__("Express Payment","surecart")),this.debugError)),t("div",{class:"sc-payment-request-button",part:"button",ref:i=>this.request=i}))}get el(){return d(this)}static get watchers(){return{loaded:["handleLoaded"],error:["handleErrorChange"]}}};u(h,["prices"],false);h.style=r;export{h as sc_stripe_payment_request};
//# sourceMappingURL=p-c12522cb.entry.js.map