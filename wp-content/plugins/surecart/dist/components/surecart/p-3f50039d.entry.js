import{r as t,h as e,a as i}from"./p-cc7ce8c7.js";import{a as s}from"./p-18e45a13.js";import{o as n}from"./p-c2833cb1.js";import{a as o}from"./p-1c2e2695.js";const r=":host{display:block}";const a=class{constructor(e){t(this,e);this.heading=undefined;this.subscription=undefined;this.paymentMethods=undefined;this.manualPaymentMethods=undefined;this.error=undefined;this.loading=undefined;this.busy=undefined;this.method=undefined}renderLoading(){return e("sc-card",{noPadding:true},e("sc-stacked-list",null,e("sc-stacked-list-row",{style:{"--columns":"4"},"mobile-size":500},[...Array(4)].map((()=>e("sc-skeleton",{style:{width:"100px",display:"inline-block"}}))))))}renderEmpty(){return e("slot",{name:"empty"},e("sc-card",null,e("sc-empty",{icon:"credit-card"},wp.i18n.__("You do not have any payment methods.","surecart"))))}currentPaymentMethodId(){var t,e,i,s,n;return((t=this.subscription)===null||t===void 0?void 0:t.manual_payment)?(e=this.subscription)===null||e===void 0?void 0:e.manual_payment_method:((s=(i=this.subscription)===null||i===void 0?void 0:i.payment_method)===null||s===void 0?void 0:s.id)||((n=this.subscription)===null||n===void 0?void 0:n.payment_method)}hasPaymentMethods(){var t,e;return((t=this.paymentMethods)===null||t===void 0?void 0:t.length)&&((e=this.manualPaymentMethods)===null||e===void 0?void 0:e.length)}hasMultiplePaymentMethods(){var t;return((t=[...(this===null||this===void 0?void 0:this.paymentMethods)||[],...(this===null||this===void 0?void 0:this.manualPaymentMethods)||[]])===null||t===void 0?void 0:t.length)>1}componentWillLoad(){n(this.el,(()=>{this.getPaymentMethods()}))}async getPaymentMethods(){var t,e,i;if(this.hasPaymentMethods())return;const s=((e=(t=this.subscription)===null||t===void 0?void 0:t.customer)===null||e===void 0?void 0:e.id)||((i=this.subscription)===null||i===void 0?void 0:i.customer);if(!s)return;try{this.loading=true;await this.fetchMethods(s)}catch(t){this.error=(t===null||t===void 0?void 0:t.messsage)||wp.i18n.__("Something went wrong","surecart");console.error(this.error)}finally{this.loading=false}}async fetchMethods(t){var e,i;this.paymentMethods=await s({path:o(`surecart/v1/payment_methods`,{expand:["card","customer","billing_agreement","paypal_account","payment_instrument","bank_account"],customer_ids:[t],reusable:true,live_mode:(e=this.subscription)===null||e===void 0?void 0:e.live_mode})});this.manualPaymentMethods=await s({path:o(`surecart/v1/manual_payment_methods`,{customer_ids:[t],reusable:true,live_mode:(i=this.subscription)===null||i===void 0?void 0:i.live_mode})})}async deleteMethod(t){const e=confirm(wp.i18n.__("Are you sure you want to remove this payment method?","surecart"));if(!e)return;try{this.busy=true;await s({path:`surecart/v1/payment_methods/${t===null||t===void 0?void 0:t.id}/detach`,method:"PATCH"});this.paymentMethods=this.paymentMethods.filter((e=>e.id!==t.id))}catch(t){this.error=(t===null||t===void 0?void 0:t.messsage)||wp.i18n.__("Something went wrong","surecart");console.error(this.error)}finally{this.busy=false}}async updateMethod(t){var e,i;const{payment_method:n}=await t.target.getFormJson();if(n===this.currentPaymentMethodId()){return}try{const t=(this.manualPaymentMethods||[]).some((t=>t.id===n));this.busy=true;this.subscription=await s({path:`surecart/v1/subscriptions/${(e=this.subscription)===null||e===void 0?void 0:e.id}`,method:"PATCH",data:{...!t?{payment_method:n,manual_payment:false}:{manual_payment_method:n,manual_payment:true}}});window.location.assign(o(window.location.href,{action:"edit",model:"subscription",id:(i=this.subscription)===null||i===void 0?void 0:i.id}))}catch(t){this.error=(t===null||t===void 0?void 0:t.messsage)||wp.i18n.__("Something went wrong","surecart");console.error(this.error)}finally{this.busy=false}}renderContent(){var t,i;if(this.loading){return this.renderLoading()}if(!((t=this.paymentMethods)===null||t===void 0?void 0:t.length)&&!((i=this.manualPaymentMethods)===null||i===void 0?void 0:i.length)){return this.renderEmpty()}return e("sc-form",{onScSubmit:t=>this.updateMethod(t)},e("sc-choices",null,this.renderList()),this.hasMultiplePaymentMethods()&&e("sc-button",{type:"primary",submit:true,full:true,size:"large",busy:this.busy,disabled:this.busy},wp.i18n.__("Update Payment Method","surecart")))}renderList(){const t=this.paymentMethods.map((t=>{const{id:i,card:s,live_mode:n,paypal_account:o}=t;return e("sc-choice",{checked:this.currentPaymentMethodId()===i,name:"payment_method",value:i,required:true},e("sc-flex",{justifyContent:"flex-start","align-items":"center"},e("sc-payment-method",{paymentMethod:t})," ",!n&&e("sc-tag",{type:"warning",size:"small"},wp.i18n.__("Test","surecart"))),e("div",{slot:"description"},!!(s===null||s===void 0?void 0:s.exp_month)&&e("span",null,wp.i18n.__("Exp.","surecart"),s===null||s===void 0?void 0:s.exp_month,"/",s===null||s===void 0?void 0:s.exp_year),!!o&&(o===null||o===void 0?void 0:o.email)),this.currentPaymentMethodId()===i&&e("sc-tag",{type:"info",slot:"price"},wp.i18n.__("Current Payment Method","surecart")))}));const i=this.manualPaymentMethods.map((t=>{const{id:i}=t;return e("sc-choice",{checked:this.currentPaymentMethodId()===i,name:"payment_method",value:i,required:true},e("sc-flex",{justifyContent:"flex-start","align-items":"center"},e("sc-manual-payment-method",{paymentMethod:t,showDescription:true})),this.currentPaymentMethodId()===i&&e("sc-tag",{type:"info",slot:"price"},wp.i18n.__("Current Payment Method","surecart")))}));return[...t,...i]}render(){var t;return e("sc-dashboard-module",{heading:this.heading||wp.i18n.__("Update Payment Method","surecart"),class:"subscription",error:this.error},e("sc-button",{slot:"end",type:"link",href:o(window.location.href,{action:"create",model:"payment_method",...((t=this.subscription)===null||t===void 0?void 0:t.live_mode)===false?{live_mode:false}:{},success_url:window.location.href})},e("sc-icon",{name:"plus",slot:"prefix"}),wp.i18n.__("Add New","surecart")),this.renderContent(),this.busy&&e("sc-block-ui",{spinner:true}))}get el(){return i(this)}};a.style=r;export{a as sc_subscription_payment_method};
//# sourceMappingURL=p-3f50039d.entry.js.map