{"file":"sc-checkout-product-price-variant-selector.js","mappings":";;;;;;;;;;;;;;;;;AAAA,MAAM,wCAAwC,GAAG,0lBAA0lB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mCCyFxmB,UAAE;;;;;mCAMF,UAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;sPA6Gd,eAAO,CAAC,UAAE,qFACmB,UAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","names":[],"sources":["./src/components/controllers/checkout-form/sc-checkout-product-price-variant-selector/sc-checkout-product-price-variant-selector.scss?tag=sc-checkout-product-price-variant-selector","./src/components/controllers/checkout-form/sc-checkout-product-price-variant-selector/sc-checkout-product-price-variant-selector.tsx"],"sourcesContent":["sc-checkout-product-price-variant-selector {\n  display: block;\n}\n\n.sc-checkout-product-price-variant-selector {\n  position: relative;\n\n  > *:not(:last-child) {\n    display: block;\n    margin-bottom: var(--sc-form-row-spacing, 0.75em);\n  }\n  &__pills-wrapper {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--sc-spacing-x-small);\n  }\n\n  &__hidden-input {\n    position: absolute !important;\n    top: 0 !important;\n    left: 0 !important;\n    opacity: 0 !important;\n    padding: 0px !important;\n    margin: 0px !important;\n    pointer-events: none !important;\n    width: 0 !important;\n  }\n}\n","import { Element, Fragment, Method, State, Watch } from '@stencil/core';\nimport { Component, h, Prop } from '@stencil/core';\nimport { __, sprintf } from '@wordpress/i18n';\nimport { Price, Product, Variant } from '../../../../types';\nimport { getLineItemByProductId } from '@store/checkout/getters';\nimport { state as checkoutState, onChange } from '@store/checkout';\nimport { getVariantFromValues } from '../../../../functions/util';\nimport { addLineItem, updateLineItem } from '@services/session';\nimport { updateFormState } from '@store/form/mutations';\nimport { createErrorNotice } from '@store/notices/mutations';\nimport { isProductVariantOptionMissing, isProductVariantOptionSoldOut } from '@store/utils';\n\n@Component({\n  tag: 'sc-checkout-product-price-variant-selector',\n  styleUrl: 'sc-checkout-product-price-variant-selector.scss',\n  shadow: false,\n})\nexport class ScProductCheckoutSelectVariantOption {\n  private input: HTMLInputElement;\n  @Element() el: HTMLScCheckoutProductPriceVariantSelectorElement;\n\n  /** The product. */\n  @Prop() product: Product;\n\n  /** The label for the price. */\n  @Prop() label: string;\n\n  /** The title for price and variant selections */\n  @Prop() selectorTitle: string;\n\n  /** Currently selected variant */\n  @State() selectedVariant: Variant;\n\n  /** Currently selected price */\n  @State() selectedPrice: Price;\n\n  /** The first selected option value */\n  @State() option1: string;\n\n  /** The second selected option value */\n  @State() option2: string;\n\n  /** The third selected option value */\n  @State() option3: string;\n\n  /** When option values are selected, attempt to find a matching variant. */\n  @Watch('option1')\n  @Watch('option2')\n  @Watch('option3')\n  handleOptionChange() {\n    this.selectedVariant = getVariantFromValues({\n      variants: this.product?.variants?.data,\n      values: {\n        ...(this.option1 ? { option_1: this.option1 } : {}),\n        ...(this.option2 ? { option_2: this.option2 } : {}),\n        ...(this.option3 ? { option_3: this.option3 } : {}),\n      },\n    });\n  }\n\n  /**\n   * Is the selected variant out of stock?\n   * @returns {boolean} Whether the selected variant is out of stock.\n   */\n  isSelectedVariantOutOfStock() {\n    return this.product?.stock_enabled && this.hasVariants() && !this.product?.allow_out_of_stock_purchases && this.selectedVariant.available_stock < 1;\n  }\n\n  /**\n   * Do we have the required selected variant?\n   * @returns {boolean} Whether the product has a required variant and it is not selected.\n   */\n  hasRequiredSelectedVariant() {\n    if (!this.hasVariants()) {\n      return true;\n    }\n    return this.selectedVariant?.id;\n  }\n\n  @Method()\n  async reportValidity() {\n    this.input.setCustomValidity('');\n\n    if (!this.hasVariants()) {\n      return this.input.reportValidity();\n    }\n\n    // We don't have a required selected variant.\n    if (!this.hasRequiredSelectedVariant()) {\n      this.input.setCustomValidity(__('Please choose an available option.', 'surecart'));\n      return this.input.reportValidity();\n    }\n\n    // don't let the person checkout with an out of stock selection.\n    if (this.isSelectedVariantOutOfStock()) {\n      this.input.setCustomValidity(__('This selection is not available.', 'surecart'));\n      return this.input.reportValidity();\n    }\n\n    return this.input.reportValidity();\n  }\n\n  getSelectedPrice() {\n    if (this.product?.prices?.data?.length === 1) {\n      return this.product?.prices?.data[0];\n    }\n    return this.selectedPrice;\n  }\n\n  /** When selected variant and selected price are set, we can update the checkout. */\n  @Watch('selectedVariant')\n  @Watch('selectedPrice')\n  async updateLineItems() {\n    const selectedPrice = this.getSelectedPrice();\n    // We need a price.\n    if (!selectedPrice?.id) return;\n    // get the existing line item.\n    const lineItem = this.lineItem();\n    // no changes.\n    if (lineItem?.price?.id === selectedPrice?.id && lineItem?.variant?.id === this.selectedVariant?.id) return;\n    // We need a selected variant if this product has variants.\n    if (!this.hasRequiredSelectedVariant()) return;\n    // Don't let the person checkout with an out of stock selection.\n    if (this.isSelectedVariantOutOfStock()) return;\n\n    // create or update the\n    try {\n      updateFormState('FETCH');\n      if (lineItem?.id) {\n        checkoutState.checkout = await updateLineItem({\n          id: lineItem?.id,\n          data: {\n            variant: this.selectedVariant?.id,\n            price: selectedPrice?.id,\n            quantity: 1,\n          },\n        });\n      } else {\n        checkoutState.checkout = await addLineItem({\n          checkout: checkoutState.checkout,\n          data: {\n            variant: this.selectedVariant?.id,\n            price: selectedPrice?.id,\n            quantity: 1,\n          },\n        });\n      }\n      updateFormState('RESOLVE');\n    } catch (e) {\n      console.error(e);\n      createErrorNotice(e);\n      updateFormState('REJECT');\n    }\n  }\n\n  private removeListener;\n  componentWillLoad() {\n    // when checkout changes, update the selected variant and price.\n    this.removeListener = onChange('checkout', () => {\n      const lineItem = this.lineItem();\n      this.selectedVariant = lineItem?.variant;\n      this.selectedPrice = lineItem?.price;\n      this.option1 = lineItem?.variant?.option_1;\n      this.option2 = lineItem?.variant?.option_2;\n      this.option3 = lineItem?.variant?.option_3;\n    });\n  }\n\n  // remove listener to prevent leaks.\n  disconnectedCallback() {\n    this.removeListener();\n  }\n\n  // get the line item by product id.\n  lineItem() {\n    return getLineItemByProductId(this.product?.id);\n  }\n\n  hasVariants() {\n    return this.product?.variants?.data?.length > 0;\n  }\n\n  render() {\n    return (\n      <sc-form-control class=\"sc-checkout-product-price-variant-selector\" label={this.selectorTitle}>\n        {(this.product.variant_options.data || []).map(({ name, values }, index) => (\n          <sc-form-control label={name}>\n            <div class=\"sc-checkout-product-price-variant-selector__pills-wrapper\">\n              {(values || []).map(value => {\n                const args = [\n                  index + 1,\n                  value,\n                  {\n                    ...(this.option1 ? { option_1: this.option1 } : {}),\n                    ...(this.option2 ? { option_2: this.option2 } : {}),\n                    ...(this.option3 ? { option_3: this.option3 } : {}),\n                  },\n                  this.product,\n                ];\n                const isUnavailable = isProductVariantOptionSoldOut.apply(void 0, args) || isProductVariantOptionMissing.apply(void 0, args);\n                return (\n                  <sc-pill-option isUnavailable={isUnavailable} isSelected={this[`option${index + 1}`] === value} onClick={() => (this[`option${index + 1}`] = value)}>\n                    <span aria-hidden=\"true\">{value}</span>\n                    <sc-visually-hidden>\n                      {sprintf(__('Select %s: %s', 'surecart'), name, value)}\n                      {isUnavailable && <Fragment> {__('(option unavailable)', 'surecart')}</Fragment>}\n                    </sc-visually-hidden>\n                  </sc-pill-option>\n                );\n              })}\n            </div>\n          </sc-form-control>\n        ))}\n\n        {this.product?.prices?.data?.length > 1 && (\n          <sc-form-control label={!!this.product.variant_options.data?.length ? this.label : null}>\n            <sc-choices>\n              {(this.product.prices.data || [])\n                .sort((a, b) => a?.position - b?.position)\n                .map(price => (\n                  <sc-price-choice-container\n                    required={true}\n                    price={price}\n                    label={price?.name || this.product?.name}\n                    checked={this.lineItem()?.price?.id === price?.id}\n                    onScChange={e => {\n                      if (e.target.checked) {\n                        this.selectedPrice = price;\n                      }\n                    }}\n                  ></sc-price-choice-container>\n                ))}\n            </sc-choices>\n          </sc-form-control>\n        )}\n\n        <input class=\"sc-checkout-product-price-variant-selector__hidden-input\" ref={el => (this.input = el as HTMLInputElement)} value={this.selectedVariant?.id}></input>\n      </sc-form-control>\n    );\n  }\n}\n"],"version":3}