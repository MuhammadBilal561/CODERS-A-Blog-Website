"use strict";const addQueryArgs$1=require("./add-query-args-17c551b6.js");function createNonceMiddleware(e){const r=(e,t)=>{const{headers:n={}}=e;for(const o in n)if("x-wp-nonce"===o.toLowerCase()&&n[o]===r.nonce)return t(e);return t({...e,headers:{...n,"X-WP-Nonce":r.nonce}})};return r.nonce=e,r}const namespaceAndEndpointMiddleware=(e,r)=>{let t,n,o=e.path;return"string"==typeof e.namespace&&"string"==typeof e.endpoint&&(t=e.namespace.replace(/^\/|\/$/g,""),n=e.endpoint.replace(/^\//,""),o=n?t+"/"+n:t),delete e.namespace,delete e.endpoint,r({...e,path:o})},createRootURLMiddleware=e=>(r,t)=>namespaceAndEndpointMiddleware(r,(r=>{let n,o=r.url,a=r.path;return"string"==typeof a&&(n=e,-1!==e.indexOf("?")&&(a=a.replace("?","&")),a=a.replace(/^\//,""),"string"==typeof n&&-1!==n.indexOf("?")&&(a=a.replace("?","&")),o=n+a),t({...r,url:o})}));function getQueryString(e){let r;try{r=new URL(e,"http://example.com").search.substring(1)}catch(e){}if(r)return r}function buildQueryString(e){let r="";const t=Object.entries(e);let n;for(;n=t.shift();){let[e,o]=n;if(Array.isArray(o)||o&&o.constructor===Object){const r=Object.entries(o).reverse();for(const[n,o]of r)t.unshift([`${e}[${n}]`,o])}else void 0!==o&&(null===o&&(o=""),r+="&"+[e,o].map(encodeURIComponent).join("="))}return r.substr(1)}function setPath(e,r,t){const n=r.length,o=n-1;for(let a=0;a<n;a++){let n=r[a];!n&&Array.isArray(e)&&(n=e.length.toString()),n=["__proto__","constructor","prototype"].includes(n)?n.toUpperCase():n;const i=!isNaN(Number(r[a+1]));e[n]=a===o?t:e[n]||(i?[]:{}),Array.isArray(e[n])&&!i&&(e[n]={...e[n]}),e=e[n]}}function getQueryArgs(e){return(getQueryString(e)||"").replace(/\+/g,"%20").split("&").reduce(((e,r)=>{const[t,n=""]=r.split("=").filter(Boolean).map(decodeURIComponent);return t&&setPath(e,t.replace(/\]/g,"").split("["),n),e}),Object.create(null))}function addQueryArgs(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1?arguments[1]:void 0;if(!r||!Object.keys(r).length)return e;let t=e;const n=e.indexOf("?");return-1!==n&&(r=Object.assign(getQueryArgs(e),r),t=t.substr(0,n)),t+"?"+buildQueryString(r)}function getQueryArg(e,r){return getQueryArgs(e)[r]}function hasQueryArg(e,r){return void 0!==getQueryArg(e,r)}function normalizePath(e){const r=e.split("?"),t=r[1],n=r[0];return t?n+"?"+t.split("&").map((e=>e.split("="))).map((e=>e.map(decodeURIComponent))).sort(((e,r)=>e[0].localeCompare(r[0]))).map((e=>e.map(encodeURIComponent))).map((e=>e.join("="))).join("&"):n}function createPreloadingMiddleware(e){const r=Object.fromEntries(Object.entries(e).map((e=>{let[r,t]=e;return[normalizePath(r),t]})));return(e,t)=>{const{parse:n=!0}=e;let o=e.path;if(!o&&e.url){const{rest_route:r,...t}=getQueryArgs(e.url);"string"==typeof r&&(o=addQueryArgs(r,t))}if("string"!=typeof o)return t(e);const a=e.method||"GET",i=normalizePath(o);if("GET"===a&&r[i]){const e=r[i];return delete r[i],prepareResponse(e,!!n)}if("OPTIONS"===a&&r[a]&&r[a][i]){const e=r[a][i];return delete r[a][i],prepareResponse(e,!!n)}return t(e)}}function prepareResponse(e,r){return Promise.resolve(r?e.body:new window.Response(JSON.stringify(e.body),{status:200,statusText:"OK",headers:e.headers}))}const modifyQuery=(e,r)=>{let{path:t,url:n,...o}=e;return{...o,url:n&&addQueryArgs(n,r),path:t&&addQueryArgs(t,r)}},parseResponse$1=e=>e.json?e.json():Promise.reject(e),parseLinkHeader=e=>{if(!e)return{};const r=e.match(/<([^>]+)>; rel="next"/);return r?{next:r[1]}:{}},getNextPageUrl=e=>{const{next:r}=parseLinkHeader(e.headers.get("link"));return r},requestContainsUnboundedQuery=e=>{const r=!!e.path&&-1!==e.path.indexOf("per_page=-1"),t=!!e.url&&-1!==e.url.indexOf("per_page=-1");return r||t},fetchAllMiddleware=async(e,r)=>{if(!1===e.parse)return r(e);if(!requestContainsUnboundedQuery(e))return r(e);const t=await apiFetch({...modifyQuery(e,{per_page:100}),parse:!1}),n=await parseResponse$1(t);if(!Array.isArray(n))return n;let o=getNextPageUrl(t);if(!o)return n;let a=[].concat(n);for(;o;){const r=await apiFetch({...e,path:void 0,url:o,parse:!1}),t=await parseResponse$1(r);a=a.concat(t),o=getNextPageUrl(r)}return a},OVERRIDE_METHODS=new Set(["PATCH","PUT","DELETE"]),DEFAULT_METHOD="GET",httpV1Middleware=(e,r)=>{const{method:t=DEFAULT_METHOD}=e;return OVERRIDE_METHODS.has(t.toUpperCase())&&(e={...e,headers:{...e.headers,"X-HTTP-Method-Override":t,"Content-Type":"application/json"},method:"POST"}),r(e)},userLocaleMiddleware=(e,r)=>("string"!=typeof e.url||hasQueryArg(e.url,"_locale")||(e.url=addQueryArgs(e.url,{_locale:"user"})),"string"!=typeof e.path||hasQueryArg(e.path,"_locale")||(e.path=addQueryArgs(e.path,{_locale:"user"})),r(e)),parseResponse=function(e){let r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return r?204===e.status?null:e.json?e.json():Promise.reject(e):e},parseJsonAndNormalizeError$1=e=>{const r={code:"invalid_json",message:wp.i18n.__("The response is not a valid JSON response.")};if(!e||!e.json)throw r;return e.json().catch((()=>{throw r}))},parseResponseAndNormalizeError=function(e){let r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return Promise.resolve(parseResponse(e,r)).catch((e=>parseAndThrowError(e,r)))};function parseAndThrowError(e){let r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!r)throw e;return parseJsonAndNormalizeError$1(e).then((e=>{const r={code:"unknown_error",message:wp.i18n.__("An unknown error occurred.")};throw e||r}))}function isMediaUploadRequest(e){const r=!!e.method&&"POST"===e.method;return(!!e.path&&-1!==e.path.indexOf("/wp/v2/media")||!!e.url&&-1!==e.url.indexOf("/wp/v2/media"))&&r}const mediaUploadMiddleware=(e,r)=>{if(!isMediaUploadRequest(e))return r(e);let t=0;const n=e=>(t++,r({path:`/wp/v2/media/${e}/post-process`,method:"POST",data:{action:"create-image-subsizes"},parse:!1}).catch((()=>t<5?n(e):(r({path:`/wp/v2/media/${e}?force=true`,method:"DELETE"}),Promise.reject()))));return r({...e,parse:!1}).catch((r=>{const t=r.headers.get("x-wp-upload-attachment-id");return r.status>=500&&r.status<600&&t?n(t).catch((()=>!1!==e.parse?Promise.reject({code:"post_process",message:wp.i18n.__("Media upload failed. If this is a photo or a large image, please scale it down and try again.")}):Promise.reject(r))):parseAndThrowError(r,e.parse)})).then((r=>parseResponseAndNormalizeError(r,e.parse)))},DEFAULT_HEADERS={Accept:"application/json, */*;q=0.1"},DEFAULT_OPTIONS={credentials:"include"},middlewares=[userLocaleMiddleware,namespaceAndEndpointMiddleware,httpV1Middleware,fetchAllMiddleware];function registerMiddleware(e){middlewares.unshift(e)}const checkStatus=e=>{if(e.status>=200&&e.status<300)return e;throw e},defaultFetchHandler=e=>{const{url:r,path:t,data:n,parse:o=!0,...a}=e;let{body:i,headers:s}=e;return s={...DEFAULT_HEADERS,...s},n&&(i=JSON.stringify(n),s["Content-Type"]="application/json"),window.fetch(r||t||window.location.href,{...DEFAULT_OPTIONS,...a,body:i,headers:s}).then((e=>Promise.resolve(e).then(checkStatus).catch((e=>parseAndThrowError(e,o))).then((e=>parseResponseAndNormalizeError(e,o)))),(e=>{if(e&&"AbortError"===e.name)throw e;throw{code:"fetch_error",message:wp.i18n.__("You are probably offline.")}}))};let fetchHandler=defaultFetchHandler;function setFetchHandler(e){fetchHandler=e}function apiFetch(e){return middlewares.reduceRight(((e,r)=>t=>r(t,e)),fetchHandler)(e).catch((r=>"rest_cookie_invalid_nonce"!==r.code?Promise.reject(r):window.fetch(apiFetch.nonceEndpoint).then(checkStatus).then((e=>e.text())).then((r=>(apiFetch.nonceMiddleware.nonce=r,apiFetch(e))))))}var _a,_b,_c,_d,_e,_f,_g;apiFetch.use=registerMiddleware,apiFetch.setFetchHandler=setFetchHandler,apiFetch.createNonceMiddleware=createNonceMiddleware,apiFetch.createPreloadingMiddleware=createPreloadingMiddleware,apiFetch.createRootURLMiddleware=createRootURLMiddleware,apiFetch.fetchAllMiddleware=fetchAllMiddleware,apiFetch.mediaUploadMiddleware=mediaUploadMiddleware,apiFetch.fetchAllMiddleware=null,apiFetch.use(apiFetch.createRootURLMiddleware((null===(_b=null===(_a=null===window||void 0===window?void 0:window.parent)||void 0===_a?void 0:_a.scData)||void 0===_b?void 0:_b.root_url)||(null===(_c=null===window||void 0===window?void 0:window.scData)||void 0===_c?void 0:_c.root_url))),(null===(_d=null===window||void 0===window?void 0:window.scData)||void 0===_d?void 0:_d.nonce)&&(apiFetch.nonceMiddleware=apiFetch.createNonceMiddleware(null===(_e=null===window||void 0===window?void 0:window.scData)||void 0===_e?void 0:_e.nonce),apiFetch.use(apiFetch.nonceMiddleware)),(null===(_f=null===window||void 0===window?void 0:window.scData)||void 0===_f?void 0:_f.nonce_endpoint)&&(apiFetch.nonceEndpoint=null===(_g=null===window||void 0===window?void 0:window.scData)||void 0===_g?void 0:_g.nonce_endpoint),apiFetch.use(((e,r)=>(e.path=addQueryArgs$1.addQueryArgs(e.path,{t:Date.now()}),r(e))));const parseJsonAndNormalizeError=e=>{const r={code:"invalid_json",message:wp.i18n.__("The response is not a valid JSON response.","surecart")};if((null==e?void 0:e.code)&&(null==e?void 0:e.message))throw e;if(!e||!e.json)throw r;return e.json().catch((()=>{throw r}))},handleNonceError=async e=>{const r=await parseJsonAndNormalizeError(e);if("rest_cookie_invalid_nonce"!==r.code)throw r;return window.fetch(apiFetch.nonceEndpoint).then((e=>{if(e.status>=200&&e.status<300)return e;throw e})).then((e=>e.text())).then((e=>{apiFetch.nonceMiddleware.nonce=e}))};exports.apiFetch=apiFetch,exports.handleNonceError=handleNonceError;